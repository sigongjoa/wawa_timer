<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•ŒíŒŒì‹œí‹°ì  ìˆ˜í•™ ì‹œê°„í‘œ ê´€ë¦¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
            background: #f5f7fa;
            padding: 20px;
            color: #333;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        h1 {
            color: #2c3e50;
        }
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #3498db;
            color: white;
        }
        .btn-primary:hover {
            background: #2980b9;
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        .btn-success:hover {
            background: #229954;
        }
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab-group {
            display: flex;
            gap: 5px;
            background: #e0e5ec;
            padding: 5px;
            border-radius: 10px;
        }
        .tab-group-label {
            font-size: 12px;
            color: #666;
            padding: 5px 10px;
            display: flex;
            align-items: center;
        }
        .tab {
            padding: 10px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .tab:hover {
            background: #fff;
        }
        .tab.active {
            background: #3498db;
            color: white;
        }
        .view-tabs .tab.active {
            background: #27ae60;
        }
        .view-tabs .tab[data-view="realtime"].active {
            background: #e67e22;
        }
        .grade-tabs .tab.active {
            background: #9b59b6;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        th {
            background: #34495e;
            color: white;
            font-weight: 500;
            white-space: nowrap;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .grade-1 { border-left: 4px solid #3498db; }
        .grade-2 { border-left: 4px solid #9b59b6; }
        .grade-3 { border-left: 4px solid #e74c3c; }
        .grade-high1 { border-left: 4px solid #f39c12; }
        .grade-high2 { border-left: 4px solid #1abc9c; }
        .grade-high3 { border-left: 4px solid #e67e22; }
        .grade-etc { border-left: 4px solid #95a5a6; }

        .grade-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            color: white;
            white-space: nowrap;
        }
        .badge-ì¤‘1 { background: #3498db; }
        .badge-ì¤‘2 { background: #9b59b6; }
        .badge-ì¤‘3 { background: #e74c3c; }
        .badge-ê³ 1 { background: #f39c12; }
        .badge-ê³ 2 { background: #1abc9c; }
        .badge-ê³ 3 { background: #e67e22; }
        .badge-ê²€ì •ê³ ì‹œ { background: #95a5a6; }

        .subject-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            background: #667eea;
            color: white;
            white-space: nowrap;
        }

        .material-note {
            font-size: 12px;
            color: #666;
            max-width: 200px;
        }
        .link-btn {
            display: inline-block;
            padding: 4px 8px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 11px;
            margin: 2px;
            transition: background 0.2s;
            cursor: pointer;
            border: none;
        }
        .link-btn:hover {
            background: #2980b9;
        }
        .link-btn.folder {
            background: #27ae60;
        }
        .link-btn.folder:hover {
            background: #229954;
        }
        .link-btn.drive {
            background: #ea4335;
        }
        .link-btn.drive:hover {
            background: #c5221f;
        }
        .links-cell {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
        }
        .time {
            font-weight: 500;
            white-space: nowrap;
        }
        .student-name {
            font-weight: 600;
            color: #2c3e50;
        }
        .day-í™” { color: #e74c3c; }
        .day-ëª© { color: #3498db; }
        .day-í†  { color: #27ae60; }

        /* ì‹œê°„ëŒ€ë³„ ë³´ê¸° */
        .timeslot-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .timeslot-day {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .timeslot-day-header {
            padding: 15px;
            font-weight: 600;
            font-size: 16px;
            text-align: center;
        }
        .timeslot-day-header.day-í™” { background: #e74c3c; color: white; }
        .timeslot-day-header.day-ëª© { background: #3498db; color: white; }
        .timeslot-day-header.day-í†  { background: #27ae60; color: white; }
        .timeslot-row {
            display: flex;
            border-bottom: 1px solid #eee;
            min-height: 40px;
        }
        .timeslot-row:last-child {
            border-bottom: none;
        }
        .timeslot-row.current-time {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        .timeslot-time {
            width: 70px;
            padding: 10px;
            font-weight: 500;
            font-size: 13px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 1px solid #eee;
        }
        .timeslot-students {
            flex: 1;
            padding: 8px 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
        }
        .timeslot-student {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
            background: #e0e5ec;
            color: #333;
        }
        .timeslot-student.badge-ì¤‘1 { background: #3498db; color: white; }
        .timeslot-student.badge-ì¤‘2 { background: #9b59b6; color: white; }
        .timeslot-student.badge-ì¤‘3 { background: #e74c3c; color: white; }
        .timeslot-student.badge-ê³ 1 { background: #f39c12; color: white; }
        .timeslot-student.badge-ê³ 2 { background: #1abc9c; color: white; }
        .timeslot-student.badge-ê³ 3 { background: #e67e22; color: white; }
        .timeslot-student.badge-ê²€ì •ê³ ì‹œ { background: #95a5a6; color: white; }
        .current-time-indicator {
            background: #28a745;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 15px;
            display: inline-block;
        }
        .timeslot-empty {
            color: #ccc;
            font-size: 12px;
            font-style: italic;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .legend {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            font-size: 13px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-color {
            width: 20px;
            height: 4px;
            border-radius: 2px;
        }

        .actions-cell {
            white-space: nowrap;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h2 {
            color: #2c3e50;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        .modal-close:hover {
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        .form-row {
            display: flex;
            gap: 15px;
        }
        .form-row .form-group {
            flex: 1;
        }
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .drive-links-list {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .drive-link-item {
            display: flex;
            gap: 5px;
        }
        .drive-link-item input {
            flex: 1;
        }
        .drive-link-item button {
            padding: 8px 12px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #27ae60;
            color: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 2000;
        }
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        .toast.error {
            background: #e74c3c;
        }

        /* ê²€ìƒ‰ */
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .search-box input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        .search-box input:focus {
            outline: none;
            border-color: #3498db;
        }

        /* PDF ì—…ë¡œë“œ */
        .pdf-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }
        .pdf-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .pdf-section-header h4 {
            margin: 0;
            color: #555;
            font-size: 14px;
        }
        .pdf-list {
            display: flex;
            flex-direction: column;
            gap: 5px;
            max-height: 300px;
            overflow-y: auto;
        }
        .pdf-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: white;
            border-radius: 5px;
            font-size: 13px;
        }
        .pdf-item-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .pdf-item .btn-sm {
            padding: 3px 8px;
            font-size: 11px;
        }
        .no-pdf {
            color: #999;
            font-size: 13px;
            text-align: center;
            padding: 10px;
        }
        .pdf-folder {
            margin-top: 8px;
        }
        .pdf-folder-header {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 10px;
            background: #e8f4fd;
            border-radius: 5px;
            font-size: 13px;
            font-weight: 500;
            color: #2980b9;
            cursor: pointer;
            user-select: none;
        }
        .pdf-folder-header:hover {
            background: #d4ebf9;
        }
        .pdf-folder-header .folder-icon {
            transition: transform 0.2s;
        }
        .pdf-folder-header.collapsed .folder-icon {
            transform: rotate(-90deg);
        }
        .pdf-folder-children {
            margin-left: 15px;
            padding-left: 10px;
            border-left: 2px solid #e0e5ec;
            margin-top: 5px;
        }
        .pdf-folder-children.hidden {
            display: none;
        }

        /* ì‹¤ì‹œê°„ ê´€ë¦¬ ë·° ìŠ¤íƒ€ì¼ */
        .realtime-container {
            display: flex;
            gap: 20px;
            height: calc(100vh - 280px);
            min-height: 500px;
        }
        .realtime-panel {
            flex: 1;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .realtime-panel-header {
            padding: 15px 20px;
            font-weight: 600;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
        }
        .realtime-panel-header.waiting {
            background: #3498db;
            color: white;
        }
        .realtime-panel-header.active {
            background: #27ae60;
            color: white;
        }
        .realtime-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        .realtime-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid #ddd;
        }
        .realtime-card:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        .realtime-card.checked-in {
            cursor: default;
        }
        .realtime-card.checked-in:hover {
            transform: none;
        }
        .realtime-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .realtime-card .card-name {
            font-weight: 600;
            font-size: 16px;
            color: #2c3e50;
        }
        .realtime-card .card-time {
            font-size: 13px;
            color: #666;
        }
        .realtime-card .card-timer {
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            background: #e9ecef;
            margin: 10px 0;
        }
        .realtime-card .card-timer.warning {
            background: #fff3cd;
            color: #856404;
        }
        .realtime-card .card-timer.overtime {
            background: #f8d7da;
            color: #721c24;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }
        .realtime-card .card-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .realtime-card .card-actions button {
            flex: 1;
        }
        .realtime-card.grade-ì¤‘1 { border-left-color: #3498db; }
        .realtime-card.grade-ì¤‘2 { border-left-color: #9b59b6; }
        .realtime-card.grade-ì¤‘3 { border-left-color: #e74c3c; }
        .realtime-card.grade-ê³ 1 { border-left-color: #f39c12; }
        .realtime-card.grade-ê³ 2 { border-left-color: #1abc9c; }
        .realtime-card.grade-ê³ 3 { border-left-color: #e67e22; }
        .realtime-card.grade-ê²€ì •ê³ ì‹œ { border-left-color: #95a5a6; }

        .realtime-card.overtime-card {
            background: #fff5f5;
            border-left-color: #e74c3c !important;
            animation: pulse-border 1.5s infinite;
        }
        @keyframes pulse-border {
            0%, 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(231, 76, 60, 0); }
        }

        .realtime-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .realtime-stat {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .realtime-stat-value {
            font-size: 24px;
            font-weight: 700;
        }
        .realtime-stat-label {
            font-size: 13px;
            color: #666;
        }
        .realtime-stat.waiting .realtime-stat-value { color: #3498db; }
        .realtime-stat.active .realtime-stat-value { color: #27ae60; }
        .realtime-stat.completed .realtime-stat-value { color: #95a5a6; }

        .realtime-current-time {
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
        }
        .realtime-current-date {
            font-size: 14px;
            color: #666;
            margin-left: 15px;
        }

        .waiting-card-hint {
            font-size: 12px;
            color: #888;
            text-align: center;
            margin-top: 5px;
        }
        .no-students-message {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        .btn-extend {
            background: #f39c12;
            color: white;
        }
        .btn-extend:hover {
            background: #e67e22;
        }
        .add-extra-student {
            border: 2px dashed #ddd;
            background: transparent;
            text-align: center;
            padding: 20px;
            color: #999;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s;
        }
        .add-extra-student:hover {
            border-color: #3498db;
            color: #3498db;
            background: #f8f9fa;
        }

        /* ìš”ì¼ ì„ íƒ ë“œë¡­ë‹¤ìš´ */
        .day-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 20px;
        }
        .day-selector label {
            font-size: 14px;
            color: #666;
        }
        .day-selector select {
            padding: 8px 15px;
            font-size: 16px;
            font-weight: 600;
            border: 2px solid #e67e22;
            border-radius: 8px;
            background: white;
            color: #e67e22;
            cursor: pointer;
            outline: none;
        }
        .day-selector select:focus {
            border-color: #d35400;
        }
        .day-selector .today-badge {
            font-size: 11px;
            padding: 3px 8px;
            background: #27ae60;
            color: white;
            border-radius: 10px;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ì•ŒíŒŒì‹œí‹°ì  ìˆ˜í•™ ë°©í•™ ì‹œê°„í‘œ</h1>
        <div class="header-buttons">
            <button class="btn btn-success" onclick="openAddModal()">+ í•™ìƒ ì¶”ê°€</button>
            <button class="btn btn-primary" onclick="saveAllData()">ğŸ’¾ ì €ì¥</button>
            <button class="btn" onclick="openNotionSettingsModal()" id="notionBtn" style="background:#444;color:white;">â˜ï¸ Notion</button>
            <button class="btn" onclick="openAiChat()" id="aiBtn" style="background:#8e44ad;color:white;">ğŸ¤– AI ë¹„ì„œ</button>
            <button class="btn" onclick="openSettings()" style="background:#6c757d;color:white;">âš™ï¸ ì„¤ì •</button>
        </div>
    </div>

    <div class="legend">
        <div class="legend-item"><div class="legend-color" style="background:#3498db"></div>ì¤‘1</div>
        <div class="legend-item"><div class="legend-color" style="background:#9b59b6"></div>ì¤‘2</div>
        <div class="legend-item"><div class="legend-color" style="background:#e74c3c"></div>ì¤‘3</div>
        <div class="legend-item"><div class="legend-color" style="background:#f39c12"></div>ê³ 1</div>
        <div class="legend-item"><div class="legend-color" style="background:#1abc9c"></div>ê³ 2</div>
        <div class="legend-item"><div class="legend-color" style="background:#e67e22"></div>ê³ 3</div>
        <div class="legend-item"><div class="legend-color" style="background:#95a5a6"></div>ê¸°íƒ€</div>
    </div>

    <div class="search-box">
        <input type="text" id="searchInput" placeholder="í•™ìƒ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰..." oninput="render()">
    </div>

    <div class="tabs">
        <div class="tab-group view-tabs">
            <span class="tab-group-label">ë³´ê¸°:</span>
            <button class="tab" data-view="realtime">ì‹¤ì‹œê°„</button>
            <button class="tab active" data-view="day">ìš”ì¼ë³„</button>
            <button class="tab" data-view="student">í•™ìƒë³„</button>
            <button class="tab" data-view="grade">í•™ë…„ë³„</button>
            <button class="tab" data-view="timeslot">ì‹œê°„ëŒ€ë³„</button>
        </div>
        <div class="tab-group day-tabs">
            <span class="tab-group-label">ìš”ì¼:</span>
            <button class="tab active" data-day="all">ì „ì²´</button>
            <button class="tab" data-day="í™”">í™”ìš”ì¼</button>
            <button class="tab" data-day="ëª©">ëª©ìš”ì¼</button>
            <button class="tab" data-day="í† ">í† ìš”ì¼</button>
        </div>
        <div class="tab-group grade-tabs">
            <span class="tab-group-label">í•™ë…„:</span>
            <button class="tab active" data-grade="all">ì „ì²´</button>
            <button class="tab" data-grade="ì¤‘1">ì¤‘1</button>
            <button class="tab" data-grade="ì¤‘2">ì¤‘2</button>
            <button class="tab" data-grade="ì¤‘3">ì¤‘3</button>
            <button class="tab" data-grade="ê³ 1">ê³ 1</button>
            <button class="tab" data-grade="ê³ 2">ê³ 2</button>
            <button class="tab" data-grade="ê³ 3">ê³ 3</button>
            <button class="tab" data-grade="ê²€ì •ê³ ì‹œ">ê¸°íƒ€</button>
        </div>
    </div>

    <div id="tableContainer"></div>

    <!-- ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal" id="studentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">í•™ìƒ ì¶”ê°€</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="studentForm" onsubmit="submitForm(event)">
                <input type="hidden" id="editIndex" value="-1">

                <div class="form-row">
                    <div class="form-group">
                        <label>ì´ë¦„ *</label>
                        <input type="text" id="formName" required>
                    </div>
                    <div class="form-group">
                        <label>í•™ë…„ *</label>
                        <select id="formGrade" required>
                            <option value="ì¤‘1">ì¤‘1</option>
                            <option value="ì¤‘2">ì¤‘2</option>
                            <option value="ì¤‘3">ì¤‘3</option>
                            <option value="ê³ 1">ê³ 1</option>
                            <option value="ê³ 2">ê³ 2</option>
                            <option value="ê³ 3">ê³ 3</option>
                            <option value="ê²€ì •ê³ ì‹œ">ê²€ì •ê³ ì‹œ</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ìš”ì¼ *</label>
                        <select id="formDay" required>
                            <option value="í™”">í™”ìš”ì¼</option>
                            <option value="ëª©">ëª©ìš”ì¼</option>
                            <option value="í† ">í† ìš”ì¼</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ì‹œì‘ì‹œê°„ *</label>
                        <input type="time" id="formStart" required>
                    </div>
                    <div class="form-group">
                        <label>ì¢…ë£Œì‹œê°„ *</label>
                        <input type="time" id="formEnd" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>ê³¼ëª© *</label>
                    <select id="formSubject" required>
                        <option value="ì¤‘1ìˆ˜í•™">ì¤‘1ìˆ˜í•™</option>
                        <option value="ì¤‘2ìˆ˜í•™">ì¤‘2ìˆ˜í•™</option>
                        <option value="ì¤‘3ìˆ˜í•™">ì¤‘3ìˆ˜í•™</option>
                        <option value="ê³µí†µìˆ˜í•™1">ê³µí†µìˆ˜í•™1</option>
                        <option value="ê³µí†µìˆ˜í•™2">ê³µí†µìˆ˜í•™2</option>
                        <option value="ìˆ˜í•™I">ìˆ˜í•™I</option>
                        <option value="ìˆ˜í•™II">ìˆ˜í•™II</option>
                        <option value="ë¯¸ì ë¶„">ë¯¸ì ë¶„</option>
                        <option value="í™•ë¥ ê³¼í†µê³„">í™•ë¥ ê³¼í†µê³„</option>
                        <option value="ê¸°í•˜">ê¸°í•˜</option>
                        <option value="ê²€ì •ê³ ì‹œìˆ˜í•™">ê²€ì •ê³ ì‹œìˆ˜í•™</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ë¹„ê³ /ì•ˆë‚´ì‚¬í•­</label>
                    <textarea id="formNote" rows="2" placeholder="ì˜ˆ: EBS ë‰´ëŸ° ì¤‘1ìˆ˜í•™ (ì´ˆë¡ìƒ‰ ì±…)"></textarea>
                </div>

                <div class="form-group">
                    <label>ë¡œì»¬ ìë£Œ í´ë”</label>
                    <div style="display:flex;gap:10px;align-items:center;">
                        <select id="formLocalFolder" style="flex:1;">
                            <option value="">ì„ íƒ ì•ˆí•¨</option>
                        </select>
                        <button type="button" class="btn btn-success btn-sm" onclick="createNewFolder()">ìƒˆ í´ë”</button>
                    </div>
                </div>

                <div class="pdf-section">
                    <div class="pdf-section-header">
                        <h4>PDF ìë£Œ ì—…ë¡œë“œ</h4>
                        <div style="display:flex;gap:8px;">
                            <button type="button" class="btn btn-primary btn-sm" onclick="selectAndUploadPdf()">+ PDF ì¶”ê°€</button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="syncPdfsToNotion()" title="ë¡œì»¬ PDFë¥¼ Notionì— ë™ê¸°í™”">â˜ï¸ Notion ë™ê¸°í™”</button>
                        </div>
                    </div>
                    <div class="pdf-list" id="pdfList">
                        <div class="no-pdf">í´ë”ë¥¼ ì„ íƒí•˜ë©´ PDF ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤</div>
                    </div>
                </div>

                <div class="form-group" style="margin-top:15px;">
                    <label>Google Drive ë§í¬</label>
                    <div class="drive-links-list" id="driveLinksContainer">
                        <div class="drive-link-item">
                            <input type="url" placeholder="https://drive.google.com/...">
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeDriveLink(this)">ì‚­ì œ</button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="addDriveLink()" style="margin-top:5px">+ ë§í¬ ì¶”ê°€</button>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
    <div class="modal" id="deleteModal">
        <div class="modal-content" style="max-width:400px">
            <div class="modal-header">
                <h2>ì‚­ì œ í™•ì¸</h2>
                <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <p id="deleteMessage" style="margin-bottom:20px"></p>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">ì·¨ì†Œ</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">ì‚­ì œ</button>
            </div>
        </div>
    </div>

    <!-- ì˜ˆì • ì™¸ í•™ìƒ ì„ íƒ ëª¨ë‹¬ -->
    <div class="modal" id="extraStudentModal">
        <div class="modal-content" style="max-width:500px">
            <div class="modal-header">
                <h2>ì˜ˆì • ì™¸ í•™ìƒ ì¶”ê°€</h2>
                <button class="modal-close" onclick="closeExtraStudentModal()">&times;</button>
            </div>
            <p style="margin-bottom:15px;color:#666;">ìˆ˜ì—…ì„ ì‹œì‘í•  í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</p>
            <div id="extraStudentList"></div>
            <div class="form-actions" style="margin-top:15px;">
                <button class="btn btn-secondary" onclick="closeExtraStudentModal()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <!-- Notion ì„¤ì • ëª¨ë‹¬ -->
    <div class="modal" id="notionModal">
        <div class="modal-content" style="max-width:550px">
            <div class="modal-header">
                <h2>â˜ï¸ Notion ì—°ë™ ì„¤ì •</h2>
                <button class="modal-close" onclick="closeNotionModal()">&times;</button>
            </div>
            <div id="notionStatus" style="padding:10px;border-radius:8px;margin-bottom:15px;background:#f8f9fa;">
                ì—°ê²° ìƒíƒœ í™•ì¸ ì¤‘...
            </div>
            <div class="form-group">
                <label>Notion API í‚¤ *</label>
                <input type="password" id="notionApiKey" placeholder="secret_xxxxxxxx...">
                <small style="color:#888;">Notion Integrationì—ì„œ ë°œê¸‰ë°›ì€ API í‚¤</small>
            </div>
            <div class="form-group">
                <label>í•™ìƒ DB ID *</label>
                <input type="text" id="notionStudentsDb" placeholder="32ìë¦¬ ID ë˜ëŠ” Notion URL">
                <small style="color:#888;">í•™ìƒ ì‹œê°„í‘œ ë°ì´í„°ë² ì´ìŠ¤</small>
            </div>
            <div class="form-group">
                <label>ì¶œì„ DB ID</label>
                <input type="text" id="notionAttendanceDb" placeholder="32ìë¦¬ ID ë˜ëŠ” Notion URL">
                <small style="color:#888;">ì¶œì„ ê¸°ë¡ ë°ì´í„°ë² ì´ìŠ¤ (ì„ íƒ)</small>
            </div>
            <div class="form-group">
                <label>PDF ìë£Œ DB ID</label>
                <input type="text" id="notionPdfsDb" placeholder="32ìë¦¬ ID ë˜ëŠ” Notion URL">
                <small style="color:#888;">PDF ìë£Œ ë©”íƒ€ë°ì´í„° ë°ì´í„°ë² ì´ìŠ¤ (ì„ íƒ)</small>
            </div>
            <div class="form-actions" style="flex-wrap:wrap;gap:10px;">
                <button class="btn btn-secondary" onclick="testNotionConnection()">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
                <button class="btn btn-primary" onclick="syncFromNotion()">Notionì—ì„œ ê°€ì ¸ì˜¤ê¸°</button>
                <button class="btn btn-success" onclick="saveNotionSettings()">ì„¤ì • ì €ì¥</button>
            </div>
            <hr style="margin:20px 0;border:none;border-top:1px solid #eee;">
            <div style="font-size:13px;color:#666;">
                <strong>Notion ë°ì´í„°ë² ì´ìŠ¤ í•„ìˆ˜ ì†ì„±:</strong>
                <ul style="margin:10px 0 0 20px;">
                    <li><strong>í•™ìƒ DB:</strong> ì´ë¦„(title), í•™ë…„(select), ìš”ì¼(select), ì‹œì‘ì‹œê°„(text), ì¢…ë£Œì‹œê°„(text), ê³¼ëª©(select), ë¹„ê³ (text)</li>
                    <li><strong>ì¶œì„ DB:</strong> ì´ë¦„(title), í•™ë…„(select), ë‚ ì§œ(date), ì²´í¬ì¸(text), ì²´í¬ì•„ì›ƒ(text), ìˆ˜ì—…ì‹œê°„(number)</li>
                    <li><strong>PDF DB:</strong> íŒŒì¼ëª…(title), í•™ìƒì´ë¦„(text), ê³¼ëª©(select), ë©”ëª¨(text)</li>
                </ul>
                <p style="margin-top:10px;color:#e67e22;">â€» PDF íŒŒì¼ì€ Notionì—ì„œ ì§ì ‘ ì²¨ë¶€í•˜ì„¸ìš” (ë¬´ì œí•œ ì €ì¥)</p>
            </div>
        </div>
    </div>

    <!-- AI ë¹„ì„œ ëª¨ë‹¬ -->
    <div class="modal" id="aiModal">
        <div class="modal-content" style="max-width:650px;height:85vh;display:flex;flex-direction:column;">
            <div class="modal-header">
                <h2>ğŸ¤– ë§¤ì“°ë´‡ AI ë¹„ì„œ</h2>
                <button class="close-btn" onclick="closeAiModal()">&times;</button>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <div id="aiStatus" style="padding:8px 12px;font-size:12px;background:#f8f9fa;border-radius:4px;flex:1;">
                    ì—°ê²° ìƒíƒœ í™•ì¸ ì¤‘...
                </div>
                <button class="btn btn-secondary btn-sm" onclick="clearAiChat()" style="margin-left:10px;font-size:12px;">ğŸ—‘ï¸ ëŒ€í™” ì´ˆê¸°í™”</button>
            </div>
            <div id="aiChatMessages" style="flex:1;overflow-y:auto;padding:10px;background:#f5f5f5;border-radius:8px;margin-bottom:10px;">
                <div class="ai-message ai-assistant">
                    ì•ˆë…•í•˜ì„¸ìš”! í•™ì› ê´€ë¦¬ë¥¼ ë„ì™€ë“œë¦¬ëŠ” <b>ë§¤ì“°ë´‡</b>ì…ë‹ˆë‹¤. ğŸ“<br><br>
                    <b>ì§ˆë¬¸ ì˜ˆì‹œ:</b><br>
                    ğŸ“… "ì˜¤ëŠ˜ ìˆ˜ì—… ì¼ì • ì•Œë ¤ì¤˜"<br>
                    ğŸ‘¨â€ğŸ“ "ì¤‘2 í•™ìƒ ëª©ë¡ ë³´ì—¬ì¤˜"<br>
                    ğŸ“ "í™ê¸¸ë™ í•™ìƒ ì •ë³´ ì•Œë ¤ì¤˜"<br>
                    ğŸ“Š "ì´ë²ˆ ì£¼ ìš”ì•½í•´ì¤˜"<br><br>
                    <span style="color:#888;font-size:12px;">ğŸ’¡ ì´ì „ ëŒ€í™”ë¥¼ ê¸°ì–µí•˜ê³ , í•„ìš”í•œ ì •ë³´ë§Œ ì°¾ì•„ì„œ ë‹µë³€í•´ìš”!</span>
                </div>
            </div>
            <div style="display:flex;gap:8px;">
                <input type="text" id="aiInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”... (ì˜ˆ: ì˜¤ëŠ˜ ëˆ„ê°€ ì™€?)" style="flex:1;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;" onkeypress="if(event.key==='Enter')sendAiMessage()">
                <button class="btn btn-primary" onclick="sendAiMessage()" style="padding:12px 20px;">ì „ì†¡</button>
            </div>
        </div>
    </div>

    <style>
        /* AI ì±„íŒ… ìŠ¤íƒ€ì¼ */
        #aiChatMessages {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .ai-message {
            padding: 10px 14px;
            border-radius: 12px;
            max-width: 85%;
            line-height: 1.5;
            font-size: 14px;
        }
        .ai-user {
            background: #3498db;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .ai-assistant {
            background: white;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .ai-loading {
            background: #f0f0f0;
            color: #888;
            align-self: flex-start;
        }
        #aiModal .modal-content {
            padding: 20px;
        }
    </style>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ê³¼ëª© ëª©ë¡
        const subjects = [
            'ì¤‘1ìˆ˜í•™', 'ì¤‘2ìˆ˜í•™', 'ì¤‘3ìˆ˜í•™',
            'ê³µí†µìˆ˜í•™1', 'ê³µí†µìˆ˜í•™2',
            'ìˆ˜í•™I', 'ìˆ˜í•™II',
            'ë¯¸ì ë¶„', 'í™•ë¥ ê³¼í†µê³„', 'ê¸°í•˜',
            'ê²€ì •ê³ ì‹œìˆ˜í•™'
        ];

        // ê¸°ë³¸ í•™ìƒ ë°ì´í„°
        const defaultStudents = [
            { name: "ìµœê³ ì€", grade: "ì¤‘1", day: "í™”", start: "15:00", end: "16:30", subject: "ì¤‘1ìˆ˜í•™", note: "EBS ë‰´ëŸ° ì¤‘1ìˆ˜í•™ (ì´ˆë¡ìƒ‰ ì±…, í’€ì§€ ì•Šì€ ë¶€ë¶„ë¶€í„° ì •ìˆ˜ì™€ ìœ ë¦¬ìˆ˜ì˜ ì‚¬ì¹™ì—°ì‚° ì „ê¹Œì§€, ê°œë…ë¶â†’ì‹¤ì „ë¶ ìˆœì„œ)", localFolder: "", driveLinks: [] },
            { name: "ìµœê³ ì€", grade: "ì¤‘1", day: "ëª©", start: "15:00", end: "16:30", subject: "ì¤‘1ìˆ˜í•™", note: "EBS ë‰´ëŸ° ì¤‘1ìˆ˜í•™ (ì´ˆë¡ìƒ‰ ì±…, í’€ì§€ ì•Šì€ ë¶€ë¶„ë¶€í„° ì •ìˆ˜ì™€ ìœ ë¦¬ìˆ˜ì˜ ì‚¬ì¹™ì—°ì‚° ì „ê¹Œì§€, ê°œë…ë¶â†’ì‹¤ì „ë¶ ìˆœì„œ)", localFolder: "", driveLinks: [] },
            { name: "ê°•ì€ì„œ", grade: "ì¤‘1", day: "ëª©", start: "15:00", end: "16:30", subject: "ì¤‘1ìˆ˜í•™", note: "RPM (ë…¸ë€ìƒ‰ ì±…, 2íšŒë…ì´ë¼ ì­‰ í’€ë©´ ë©ë‹ˆë‹¤)", localFolder: "", driveLinks: [] },
            { name: "ê°•ì€ì„œ", grade: "ì¤‘1", day: "í† ", start: "13:00", end: "14:30", subject: "ì¤‘1ìˆ˜í•™", note: "RPM (ë…¸ë€ìƒ‰ ì±…, 2íšŒë…ì´ë¼ ì­‰ í’€ë©´ ë©ë‹ˆë‹¤)", localFolder: "", driveLinks: [] },
            { name: "ë°•ë„ì€", grade: "ì¤‘1", day: "í™”", start: "15:30", end: "17:00", subject: "ì¤‘1ìˆ˜í•™", note: "EBS ë‰´ëŸ° ì¤‘1ìˆ˜í•™ (ì´ˆë¡ìƒ‰ ì±…, í’€ì§€ ì•Šì€ ë¶€ë¶„ë¶€í„° ì •ìˆ˜ì™€ ìœ ë¦¬ìˆ˜ì˜ ì‚¬ì¹™ì—°ì‚° ì „ê¹Œì§€, ê°œë…ë¶â†’ì‹¤ì „ë¶ ìˆœì„œ)", localFolder: "", driveLinks: [] },
            { name: "ë°•ë„ì€", grade: "ì¤‘1", day: "ëª©", start: "15:30", end: "17:00", subject: "ì¤‘1ìˆ˜í•™", note: "EBS ë‰´ëŸ° ì¤‘1ìˆ˜í•™ (ì´ˆë¡ìƒ‰ ì±…, í’€ì§€ ì•Šì€ ë¶€ë¶„ë¶€í„° ì •ìˆ˜ì™€ ìœ ë¦¬ìˆ˜ì˜ ì‚¬ì¹™ì—°ì‚° ì „ê¹Œì§€, ê°œë…ë¶â†’ì‹¤ì „ë¶ ìˆœì„œ)", localFolder: "", driveLinks: [] },

            { name: "ê¹€ì„±ì¤€", grade: "ì¤‘2", day: "í™”", start: "14:00", end: "16:00", subject: "ì¤‘2ìˆ˜í•™", note: "", localFolder: "ê¹€ì§€í›„ ê¹€ì„±ì¤€ ê¶Œìˆœìš°", driveLinks: ["https://drive.google.com/file/d/1F59yTPbcXYxUrL60IHTsW9HeaK1zSFYL/view", "https://drive.google.com/file/d/1x03Bc3O9WlDDP9pZkozYlxMcJgwos3if/view", "https://drive.google.com/file/d/1AKXS4oqjOUZ1HXLQYXUQzmfA0GDVoMqz/view"] },
            { name: "ê¹€ì„±ì¤€", grade: "ì¤‘2", day: "ëª©", start: "14:00", end: "16:30", subject: "ì¤‘2ìˆ˜í•™", note: "", localFolder: "ê¹€ì§€í›„ ê¹€ì„±ì¤€ ê¶Œìˆœìš°", driveLinks: ["https://drive.google.com/file/d/10LHuhZeeWz3N0rHehbIvRhilct69027z/view", "https://drive.google.com/file/d/1dDFyHWwLVuqHazMbrpb_Yw9MKJolRVzb/view"] },
            { name: "ê¹€ì§€í›„", grade: "ì¤‘2", day: "í™”", start: "18:00", end: "19:30", subject: "ì¤‘2ìˆ˜í•™", note: "", localFolder: "ê¹€ì§€í›„ ê¹€ì„±ì¤€ ê¶Œìˆœìš°", driveLinks: ["https://drive.google.com/file/d/1F59yTPbcXYxUrL60IHTsW9HeaK1zSFYL/view", "https://drive.google.com/file/d/1x03Bc3O9WlDDP9pZkozYlxMcJgwos3if/view", "https://drive.google.com/file/d/1AKXS4oqjOUZ1HXLQYXUQzmfA0GDVoMqz/view"] },
            { name: "ê¹€ì§€í›„", grade: "ì¤‘2", day: "ëª©", start: "18:00", end: "19:30", subject: "ì¤‘2ìˆ˜í•™", note: "", localFolder: "ê¹€ì§€í›„ ê¹€ì„±ì¤€ ê¶Œìˆœìš°", driveLinks: ["https://drive.google.com/file/d/10LHuhZeeWz3N0rHehbIvRhilct69027z/view", "https://drive.google.com/file/d/1dDFyHWwLVuqHazMbrpb_Yw9MKJolRVzb/view"] },
            { name: "ê¶Œìˆœìš°", grade: "ì¤‘2", day: "í™”", start: "14:00", end: "15:30", subject: "ì¤‘2ìˆ˜í•™", note: "", localFolder: "ê¹€ì§€í›„ ê¹€ì„±ì¤€ ê¶Œìˆœìš°", driveLinks: ["https://drive.google.com/file/d/1F59yTPbcXYxUrL60IHTsW9HeaK1zSFYL/view", "https://drive.google.com/file/d/1x03Bc3O9WlDDP9pZkozYlxMcJgwos3if/view", "https://drive.google.com/file/d/1AKXS4oqjOUZ1HXLQYXUQzmfA0GDVoMqz/view"] },
            { name: "ê¶Œìˆœìš°", grade: "ì¤‘2", day: "ëª©", start: "14:00", end: "15:30", subject: "ì¤‘2ìˆ˜í•™", note: "", localFolder: "ê¹€ì§€í›„ ê¹€ì„±ì¤€ ê¶Œìˆœìš°", driveLinks: ["https://drive.google.com/file/d/10LHuhZeeWz3N0rHehbIvRhilct69027z/view", "https://drive.google.com/file/d/1dDFyHWwLVuqHazMbrpb_Yw9MKJolRVzb/view"] },
            { name: "ê¶Œìˆœìš°", grade: "ì¤‘2", day: "í† ", start: "13:00", end: "14:30", subject: "ì¤‘2ìˆ˜í•™", note: "", localFolder: "ê¹€ì§€í›„ ê¹€ì„±ì¤€ ê¶Œìˆœìš°", driveLinks: ["https://drive.google.com/file/d/10LHuhZeeWz3N0rHehbIvRhilct69027z/view", "https://drive.google.com/file/d/1dDFyHWwLVuqHazMbrpb_Yw9MKJolRVzb/view"] },

            { name: "ë¥˜í˜¸ì§„", grade: "ì¤‘3", day: "í™”", start: "15:00", end: "18:00", subject: "ì¤‘3ìˆ˜í•™", note: "ë°˜ë“œì‹œ ì„œìˆ í˜• ì‹ì„ ì ì–´ì•¼ í•©ë‹ˆë‹¤", localFolder: "ë¥˜í˜¸ì§„(ë°˜ë“œì‹œ ì„œìˆ í˜• ì‹ì„ ì ì–´ì•¼ í•©ë‹ˆë‹¤)", driveLinks: ["https://drive.google.com/file/d/1TW-SlgtvsZoqf228JMULL3pOG6hqBkr_/view", "https://drive.google.com/file/d/1o1ZH6K69UlpuufayrXHTeavIG_zplkxW/view", "https://drive.google.com/file/d/1qWw1xPZsFEvLcdUX0siCOJYQFWZwoWnB/view", "https://drive.google.com/file/d/1sA5uYWHBiW14X1oGxXhnn_blJQrSAR_1/view"] },
            { name: "ë¥˜í˜¸ì§„", grade: "ì¤‘3", day: "ëª©", start: "15:00", end: "16:30", subject: "ì¤‘3ìˆ˜í•™", note: "ë°˜ë“œì‹œ ì„œìˆ í˜• ì‹ì„ ì ì–´ì•¼ í•©ë‹ˆë‹¤", localFolder: "ë¥˜í˜¸ì§„(ë°˜ë“œì‹œ ì„œìˆ í˜• ì‹ì„ ì ì–´ì•¼ í•©ë‹ˆë‹¤)", driveLinks: ["https://drive.google.com/file/d/13-_0-CkWKjGEAPdNMpLHjIHUnRsmGc19/view", "https://drive.google.com/file/d/1h_YQFAYu7LZ5QluTlf8JTY2QZ7GmoDrD/view"] },
            { name: "ì‹ ì±„ì›", grade: "ì¤‘3", day: "í™”", start: "16:00", end: "19:00", subject: "ì¤‘3ìˆ˜í•™", note: "", localFolder: "ì‹ ì±„ì›", driveLinks: ["https://drive.google.com/drive/folders/18uWh-fESqsv0jIJO_tVbjZQEakq2C-0T"] },
            { name: "ì‹ ì±„ì›", grade: "ì¤‘3", day: "ëª©", start: "16:00", end: "17:30", subject: "ì¤‘3ìˆ˜í•™", note: "", localFolder: "ì‹ ì±„ì›", driveLinks: ["https://drive.google.com/drive/folders/18uWh-fESqsv0jIJO_tVbjZQEakq2C-0T"] },

            { name: "ì•ˆì„±ë¯¼", grade: "ê³ 1", day: "í™”", start: "17:00", end: "19:30", subject: "ê³µí†µìˆ˜í•™1", note: "", localFolder: "ì •ìœ¤ì¬ í•˜ì§„ì„œ ì•ˆì„±ë¯¼", driveLinks: [] },
            { name: "ì•ˆì„±ë¯¼", grade: "ê³ 1", day: "ëª©", start: "17:00", end: "19:00", subject: "ê³µí†µìˆ˜í•™1", note: "", localFolder: "ì •ìœ¤ì¬ í•˜ì§„ì„œ ì•ˆì„±ë¯¼", driveLinks: [] },
            { name: "ë¥˜í•˜ì§„", grade: "ê³ 1", day: "ëª©", start: "15:30", end: "18:30", subject: "ê³µí†µìˆ˜í•™1", note: "", localFolder: "ë¥˜í•˜ì§„", driveLinks: ["https://drive.google.com/drive/folders/1c66rQPyVwjvjl91hc_sxC-1n62dZqD35"] },
            { name: "í•˜ì§„ì„œ", grade: "ê³ 1", day: "í™”", start: "17:00", end: "18:30", subject: "ê³µí†µìˆ˜í•™1", note: "", localFolder: "ì •ìœ¤ì¬ í•˜ì§„ì„œ ì•ˆì„±ë¯¼", driveLinks: [] },
            { name: "í•˜ì§„ì„œ", grade: "ê³ 1", day: "ëª©", start: "17:00", end: "18:30", subject: "ê³µí†µìˆ˜í•™1", note: "", localFolder: "ì •ìœ¤ì¬ í•˜ì§„ì„œ ì•ˆì„±ë¯¼", driveLinks: [] },
            { name: "ì •ìœ¤ì¬", grade: "ê³ 1", day: "í™”", start: "16:00", end: "18:30", subject: "ê³µí†µìˆ˜í•™1", note: "", localFolder: "ì •ìœ¤ì¬ í•˜ì§„ì„œ ì•ˆì„±ë¯¼", driveLinks: [] },
            { name: "ì •ìœ¤ì¬", grade: "ê³ 1", day: "ëª©", start: "16:00", end: "18:00", subject: "ê³µí†µìˆ˜í•™1", note: "", localFolder: "ì •ìœ¤ì¬ í•˜ì§„ì„œ ì•ˆì„±ë¯¼", driveLinks: [] },

            { name: "ë°•ë„ìœ¤", grade: "ê³ 2", day: "í™”", start: "14:30", end: "16:00", subject: "ìˆ˜í•™I", note: "", localFolder: "ìµœì€ì„œ ë°•ë„ìœ¤ ë¬¸ì •ë¹ˆ", driveLinks: [] },
            { name: "ë°•ë„ìœ¤", grade: "ê³ 2", day: "ëª©", start: "14:30", end: "16:00", subject: "ìˆ˜í•™I", note: "", localFolder: "ìµœì€ì„œ ë°•ë„ìœ¤ ë¬¸ì •ë¹ˆ", driveLinks: [] },
            { name: "ë°•ë„ìœ¤", grade: "ê³ 2", day: "í† ", start: "14:30", end: "16:00", subject: "ìˆ˜í•™I", note: "", localFolder: "ìµœì€ì„œ ë°•ë„ìœ¤ ë¬¸ì •ë¹ˆ", driveLinks: [] },
            { name: "ìµœì€ì„œ", grade: "ê³ 2", day: "í™”", start: "17:00", end: "19:30", subject: "ìˆ˜í•™I", note: "", localFolder: "ìµœì€ì„œ ë°•ë„ìœ¤ ë¬¸ì •ë¹ˆ", driveLinks: [] },
            { name: "ìµœì€ì„œ", grade: "ê³ 2", day: "ëª©", start: "18:00", end: "20:00", subject: "ìˆ˜í•™I", note: "", localFolder: "ìµœì€ì„œ ë°•ë„ìœ¤ ë¬¸ì •ë¹ˆ", driveLinks: [] },
            { name: "ë¬¸ì •ë¹ˆ", grade: "ê³ 2", day: "í™”", start: "16:00", end: "17:30", subject: "ìˆ˜í•™I", note: "", localFolder: "ìµœì€ì„œ ë°•ë„ìœ¤ ë¬¸ì •ë¹ˆ", driveLinks: [] },
            { name: "ë¬¸ì •ë¹ˆ", grade: "ê³ 2", day: "ëª©", start: "16:00", end: "17:30", subject: "ìˆ˜í•™I", note: "", localFolder: "ìµœì€ì„œ ë°•ë„ìœ¤ ë¬¸ì •ë¹ˆ", driveLinks: [] },
            { name: "ë¬¸ì •ë¹ˆ", grade: "ê³ 2", day: "í† ", start: "14:30", end: "16:00", subject: "ìˆ˜í•™I", note: "", localFolder: "ìµœì€ì„œ ë°•ë„ìœ¤ ë¬¸ì •ë¹ˆ", driveLinks: [] },
            { name: "ì†ë™ë¯¼", grade: "ê³ 2", day: "í™”", start: "15:30", end: "18:00", subject: "ì¤‘1ìˆ˜í•™", note: "", localFolder: "ì†ë™ë¯¼", driveLinks: ["https://drive.google.com/drive/folders/1N92uzDtMA1vKDMWaDO6aJUg9kHREFoYN"] },
            { name: "ì†ë™ë¯¼", grade: "ê³ 2", day: "ëª©", start: "14:00", end: "16:00", subject: "ì¤‘1ìˆ˜í•™", note: "", localFolder: "ì†ë™ë¯¼", driveLinks: ["https://drive.google.com/drive/folders/1N92uzDtMA1vKDMWaDO6aJUg9kHREFoYN"] },
            { name: "ê¶Œë„í›ˆ", grade: "ê³ 2", day: "í™”", start: "18:00", end: "19:30", subject: "ìˆ˜í•™I", note: "ì‰¬ìš´ ë¬¸ì œë§Œ ì§„ë„ ë‚˜ê°€ê¸°. 1-1-1 í’€ì—ˆë‹¤ê³  í•´ë„ ë³µìŠµì°¨ì›ì—ì„œ ë‹¤ì‹œ í’€ê¸°", localFolder: "ê¶Œë„í›ˆ (ì‰¬ìš´ ë¬¸ì œë§Œ ì§„ë„ë¥¼ ë‚˜ê°€ì£¼ì‹œë©´ ë©ë‹ˆë‹¤)", driveLinks: ["https://drive.google.com/file/d/1VAmZRE1L0zeEzLlaAZyq8PK9yUNicxWW/view"] },
            { name: "ê¶Œë„í›ˆ", grade: "ê³ 2", day: "ëª©", start: "18:00", end: "19:30", subject: "ìˆ˜í•™I", note: "", localFolder: "ê¶Œë„í›ˆ", driveLinks: ["https://drive.google.com/file/d/1w8feeERcI6flA4ApAlldxEe4nujFiITD/view"] },

            { name: "ìœ¤ìŠ¹í™˜", grade: "ê³ 3", day: "ëª©", start: "16:30", end: "18:00", subject: "ìˆ˜í•™II", note: "í‰ê· ê°’ì˜ ì •ë¦¬, ìµœëŒ€ìµœì†Œ ì •ë¦¬ ë¶€ë¶„ì€ í’€ì§€ ì•ŠìŒ", localFolder: "ìœ¤ìŠ¹í™˜(í‰ê· ê°’ì˜ ì •ë¦¬, ìµœëŒ€ìµœì†Œ ì •ë¦¬ ë¶€ë¶„ì€ í’€ì§€ ì•ŠìŠµë‹ˆë‹¤)", driveLinks: [] },
            { name: "ì†¡í•˜ì„ ", grade: "ê³ 3", day: "ëª©", start: "18:00", end: "19:30", subject: "ìˆ˜í•™II", note: "", localFolder: "ì†¡í•˜ì„ ", driveLinks: ["https://drive.google.com/drive/folders/13Qdtkei9ZxQDVwWrU9_ABfjoRjhSA3tZ"] },
            { name: "ì†¡í•˜ì„ ", grade: "ê³ 3", day: "í† ", start: "13:00", end: "14:30", subject: "ìˆ˜í•™II", note: "", localFolder: "ì†¡í•˜ì„ ", driveLinks: ["https://drive.google.com/drive/folders/13Qdtkei9ZxQDVwWrU9_ABfjoRjhSA3tZ"] },
            { name: "ê¹€ê´‘ë¯¼", grade: "ê³ 3", day: "í™”", start: "15:00", end: "16:30", subject: "í™•ë¥ ê³¼í†µê³„", note: "ì´í•­ì •ë¦¬", localFolder: "ê¹€ê´‘ë¯¼", driveLinks: ["https://drive.google.com/file/d/1wtE-L37eFVoAxpuW916i2VJTSljxyJxr/view", "https://drive.google.com/file/d/1cEubNlrt4Qm5KXX1VhdTW3J8WLv-UizK/view", "https://drive.google.com/file/d/1l-mPSoD0OWWOAKTfzFhilesxLvoXIYdc/view"] },
            { name: "ê¹€ê´‘ë¯¼", grade: "ê³ 3", day: "ëª©", start: "15:00", end: "16:30", subject: "í™•ë¥ ê³¼í†µê³„", note: "ì´í•­ì •ë¦¬", localFolder: "ê¹€ê´‘ë¯¼", driveLinks: ["https://drive.google.com/file/d/1wtE-L37eFVoAxpuW916i2VJTSljxyJxr/view"] },
            { name: "ë°•ë™ì§„", grade: "ê³ 3", day: "í™”", start: "15:30", end: "17:00", subject: "í™•ë¥ ê³¼í†µê³„", note: "", localFolder: "ë°•ë™ì§„", driveLinks: ["https://drive.google.com/drive/folders/1gw2BLEqFMV4FUbW4CNZvpRhiFKbV4hBb"] },
            { name: "ë°•ë™ì§„", grade: "ê³ 3", day: "ëª©", start: "15:00", end: "16:30", subject: "í™•ë¥ ê³¼í†µê³„", note: "", localFolder: "ë°•ë™ì§„", driveLinks: ["https://drive.google.com/drive/folders/1gw2BLEqFMV4FUbW4CNZvpRhiFKbV4hBb"] },

            { name: "ì˜ˆì›", grade: "ê²€ì •ê³ ì‹œ", day: "í™”", start: "14:00", end: "16:30", subject: "ê²€ì •ê³ ì‹œìˆ˜í•™", note: "ì§„ë„ ë‚˜ê°€ê¸° - ë‹¨ì›ë³„ë¡œ ê¸°ì´ˆ ë¬¸ì œë§Œ í’€ê¸°", localFolder: "ì˜ˆì›(ì§„ë„ë¥¼ ë‚˜ê°€ì•¼ í•©ë‹ˆë‹¤-ë‹¨ì›ë³„ë¡œ ê¸°ì´ˆ ë¬¸ì œë§Œ í’€ë©´ ë©ë‹ˆë‹¤)", driveLinks: [] },
            { name: "ì˜ˆì›", grade: "ê²€ì •ê³ ì‹œ", day: "í† ", start: "14:00", end: "16:00", subject: "ê²€ì •ê³ ì‹œìˆ˜í•™", note: "ì§„ë„ ë‚˜ê°€ê¸° - ë‹¨ì›ë³„ë¡œ ê¸°ì´ˆ ë¬¸ì œë§Œ í’€ê¸°", localFolder: "ì˜ˆì›(ì§„ë„ë¥¼ ë‚˜ê°€ì•¼ í•©ë‹ˆë‹¤-ë‹¨ì›ë³„ë¡œ ê¸°ì´ˆ ë¬¸ì œë§Œ í’€ë©´ ë©ë‹ˆë‹¤)", driveLinks: [] },
        ];

        let students = [];
        let folders = [];
        let currentView = 'day';
        let currentDay = 'all';
        let currentGrade = 'all';
        let deleteIndex = -1;

        // ì‹¤ì‹œê°„ ê´€ë¦¬ ê´€ë ¨ ë³€ìˆ˜
        let activeSessions = [];  // í˜„ì¬ ìˆ˜ì—… ì¤‘ì¸ í•™ìƒë“¤
        let realtimeInterval = null;  // íƒ€ì´ë¨¸ ì¸í„°ë²Œ
        let todayAttendance = { date: '', records: [] };  // ì˜¤ëŠ˜ ì¶œì„ ê¸°ë¡
        let selectedClassDay = null;  // ì„ íƒëœ ìˆ˜ì—… ìš”ì¼ (í™”/ëª©/í† )

        // ì´ˆê¸°í™”
        async function init() {
            // í´ë” ëª©ë¡ ë¡œë“œ
            folders = await window.electronAPI.getFolders();
            updateFolderSelect();

            // ì €ì¥ëœ ë°ì´í„° ë¡œë“œ
            const savedData = await window.electronAPI.loadData();
            if (savedData && savedData.students) {
                students = savedData.students;
            } else {
                students = [...defaultStudents];
            }

            // ì¶œì„ ë°ì´í„° ë¡œë“œ
            await loadAttendanceData();

            render();
        }

        function updateFolderSelect() {
            const select = document.getElementById('formLocalFolder');
            select.innerHTML = '<option value="">ì„ íƒ ì•ˆí•¨</option>';
            folders.forEach(folder => {
                select.innerHTML += `<option value="${folder}">${folder}</option>`;
            });
        }

        function getGradeClass(grade) {
            const map = {
                'ì¤‘1': 'grade-1',
                'ì¤‘2': 'grade-2',
                'ì¤‘3': 'grade-3',
                'ê³ 1': 'grade-high1',
                'ê³ 2': 'grade-high2',
                'ê³ 3': 'grade-high3',
                'ê²€ì •ê³ ì‹œ': 'grade-etc'
            };
            return map[grade] || 'grade-etc';
        }

        function getGradeOrder(grade) {
            const order = ['ì¤‘1', 'ì¤‘2', 'ì¤‘3', 'ê³ 1', 'ê³ 2', 'ê³ 3', 'ê²€ì •ê³ ì‹œ'];
            return order.indexOf(grade);
        }

        function timeToMinutes(time) {
            const [h, m] = time.split(':').map(Number);
            return h * 60 + m;
        }

        // 30ë¶„ ë‹¨ìœ„ íƒ€ì„ìŠ¬ë¡¯ ìƒì„± (13:00 ~ 20:00)
        function generateTimeSlots() {
            const slots = [];
            for (let h = 13; h <= 20; h++) {
                slots.push(`${String(h).padStart(2, '0')}:00`);
                if (h < 20) {
                    slots.push(`${String(h).padStart(2, '0')}:30`);
                }
            }
            return slots;
        }

        // íŠ¹ì • ì‹œê°„ëŒ€ì— ìˆ˜ì—… ì¤‘ì¸ í•™ìƒ ì¡°íšŒ
        function getStudentsInTimeSlot(day, slotTime) {
            const slotMinutes = timeToMinutes(slotTime);
            const slotEnd = slotMinutes + 30;

            return students.filter(s => {
                if (s.day !== day) return false;
                const startMin = timeToMinutes(s.start);
                const endMin = timeToMinutes(s.end);
                // ìˆ˜ì—… ì‹œê°„ê³¼ 30ë¶„ ìŠ¬ë¡¯ì´ ê²¹ì¹˜ëŠ”ì§€ í™•ì¸
                return startMin < slotEnd && endMin > slotMinutes;
            }).sort((a, b) => getGradeOrder(a.grade) - getGradeOrder(b.grade));
        }

        // í˜„ì¬ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
        function getCurrentTimeSlot() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const slot = minutes < 30 ? '00' : '30';
            return `${String(hours).padStart(2, '0')}:${slot}`;
        }

        // í˜„ì¬ ìš”ì¼ ê°€ì ¸ì˜¤ê¸° (í™”, ëª©, í† )
        function getCurrentDay() {
            const dayMap = { 2: 'í™”', 4: 'ëª©', 6: 'í† ' };
            return dayMap[new Date().getDay()] || null;
        }

        // ì‹œê°„ëŒ€ë³„ ë³´ê¸° ë Œë”ë§
        function renderTimeSlotView() {
            const timeSlots = generateTimeSlots();
            const days = ['í™”', 'ëª©', 'í† '];
            const currentSlot = getCurrentTimeSlot();
            const currentDay = getCurrentDay();
            const now = new Date();
            const currentTimeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

            let html = `<div class="current-time-indicator">í˜„ì¬ ì‹œê°: ${currentTimeStr}</div>`;
            html += '<div class="timeslot-container">';

            days.forEach(day => {
                const isToday = day === currentDay;
                html += `
                    <div class="timeslot-day">
                        <div class="timeslot-day-header day-${day}">${day}ìš”ì¼${isToday ? ' (ì˜¤ëŠ˜)' : ''}</div>
                `;

                timeSlots.forEach(slot => {
                    const studentsInSlot = getStudentsInTimeSlot(day, slot);
                    const isCurrent = isToday && slot === currentSlot;

                    html += `
                        <div class="timeslot-row${isCurrent ? ' current-time' : ''}">
                            <div class="timeslot-time">${slot}</div>
                            <div class="timeslot-students">
                    `;

                    if (studentsInSlot.length > 0) {
                        studentsInSlot.forEach(s => {
                            html += `<span class="timeslot-student badge-${s.grade}" title="${s.subject} (${s.start}~${s.end})">${s.name}</span>`;
                        });
                    } else {
                        html += '<span class="timeslot-empty">-</span>';
                    }

                    html += `
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            });

            html += '</div>';
            return html;
        }

        // ===== ì‹¤ì‹œê°„ ê´€ë¦¬ ê¸°ëŠ¥ =====

        // ì˜¤ëŠ˜ ë‚ ì§œ ë¬¸ìì—´ (YYYY-MM-DD)
        function getTodayDateString() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        }

        // í˜„ì¬ ì‹œê° ë¬¸ìì—´ (HH:MM:SS)
        function getCurrentTimeString() {
            const now = new Date();
            return `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
        }

        // ì„ íƒëœ ìš”ì¼ì— ì˜ˆì •ëœ í•™ìƒ ëª©ë¡ (ì²´í¬ì¸ ì•ˆí•œ í•™ìƒë§Œ)
        function getWaitingStudents() {
            // ì„ íƒëœ ìš”ì¼ì´ ì—†ìœ¼ë©´ ì˜¤ëŠ˜ ìš”ì¼ë¡œ ì„¤ì •
            if (!selectedClassDay) {
                const weekDays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                selectedClassDay = weekDays[new Date().getDay()];
            }

            // ì„ íƒëœ ìš”ì¼ì— ì˜ˆì •ëœ í•™ìƒë“¤ (í•™ìƒ ë°ì´í„°ì˜ day í•„ë“œì™€ ë§¤ì¹­)
            const dayStudents = students.filter(s => s.day === selectedClassDay);

            // ì´ë¯¸ ì²´í¬ì¸í•œ í•™ìƒ ì´ë¦„ ëª©ë¡
            const checkedInNames = activeSessions.map(s => s.studentName);

            // ì¤‘ë³µ ì œê±° (ê°™ì€ í•™ìƒì´ ì—¬ëŸ¬ ì‹œê°„ëŒ€ì— ìˆì„ ìˆ˜ ìˆìŒ)
            const uniqueStudents = [];
            const seenNames = new Set();

            for (const student of dayStudents) {
                if (!seenNames.has(student.name) && !checkedInNames.includes(student.name)) {
                    seenNames.add(student.name);
                    uniqueStudents.push(student);
                }
            }

            // ì˜ˆì • ì‹œê°„ìˆœ ì •ë ¬
            return uniqueStudents.sort((a, b) => timeToMinutes(a.start) - timeToMinutes(b.start));
        }

        // ìš”ì¼ ë³€ê²½ í•¸ë“¤ëŸ¬
        function changeClassDay(day) {
            selectedClassDay = day;
            renderRealtimeView();
        }

        // í•™ìƒ ì²´í¬ì¸
        function checkInStudent(studentName, grade, scheduledTime = '') {
            const now = new Date();
            const checkInTime = now.toISOString();
            const expectedEndTime = new Date(now.getTime() + 90 * 60 * 1000).toISOString();

            const session = {
                studentName,
                grade,
                scheduledTime,
                checkInTime,
                expectedEndTime,
                status: 'active'
            };

            activeSessions.push(session);
            renderRealtimeView();
            showToast(`${studentName} í•™ìƒ ìˆ˜ì—… ì‹œì‘!`);
        }

        // í•™ìƒ ì²´í¬ì•„ì›ƒ
        async function checkOutStudent(studentName) {
            const sessionIndex = activeSessions.findIndex(s => s.studentName === studentName);
            if (sessionIndex === -1) return;

            const session = activeSessions[sessionIndex];
            const now = new Date();
            const checkInDate = new Date(session.checkInTime);
            const duration = Math.round((now - checkInDate) / 60000);  // ë¶„ ë‹¨ìœ„

            // ì¶œì„ ê¸°ë¡ ì €ì¥
            const record = {
                studentName: session.studentName,
                grade: session.grade,
                scheduledTime: session.scheduledTime,
                checkIn: checkInDate.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }),
                checkOut: now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }),
                duration: duration
            };

            // ì˜¤ëŠ˜ ë‚ ì§œ í™•ì¸ ë° ê¸°ë¡ ì¶”ê°€
            const today = getTodayDateString();
            if (todayAttendance.date !== today) {
                todayAttendance = { date: today, records: [] };
            }
            todayAttendance.records.push(record);

            // ì¶œì„ ë°ì´í„° ì €ì¥ (ë¡œì»¬)
            await saveAttendanceData();

            // Notionì— ì¶œì„ ê¸°ë¡ ë™ê¸°í™”
            await syncAttendanceToNotion(record);

            // ì„¸ì…˜ì—ì„œ ì œê±°
            activeSessions.splice(sessionIndex, 1);
            renderRealtimeView();
            showToast(`${studentName} í•™ìƒ ìˆ˜ì—… ì¢…ë£Œ! (${duration}ë¶„)`);
        }

        // ì‹œê°„ ì—°ì¥ (+10ë¶„)
        function extendSession(studentName) {
            const session = activeSessions.find(s => s.studentName === studentName);
            if (!session) return;

            const currentEnd = new Date(session.expectedEndTime);
            session.expectedEndTime = new Date(currentEnd.getTime() + 10 * 60 * 1000).toISOString();
            session.status = 'active';  // overtimeì—ì„œ activeë¡œ ë³€ê²½

            renderRealtimeView();
            showToast(`${studentName} í•™ìƒ 10ë¶„ ì—°ì¥!`);
        }

        // ë‚¨ì€ ì‹œê°„ ê³„ì‚° (ì´ˆ ë‹¨ìœ„)
        function getRemainingSeconds(expectedEndTime) {
            const now = new Date();
            const end = new Date(expectedEndTime);
            return Math.floor((end - now) / 1000);
        }

        // ë‚¨ì€ ì‹œê°„ í¬ë§· (MM:SS ë˜ëŠ” -MM:SS)
        function formatRemainingTime(seconds) {
            const absSeconds = Math.abs(seconds);
            const mins = Math.floor(absSeconds / 60);
            const secs = absSeconds % 60;
            const sign = seconds < 0 ? '-' : '';
            return `${sign}${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        // ì‹¤ì‹œê°„ ë·° ë Œë”ë§
        function renderRealtimeView() {
            const today = getCurrentDay();
            const now = new Date();
            const currentTimeStr = getCurrentTimeString().slice(0, 5);
            const dateStr = `${now.getFullYear()}ë…„ ${now.getMonth() + 1}ì›” ${now.getDate()}ì¼`;
            const weekDays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            const todayWeekDay = weekDays[now.getDay()];

            // ì„ íƒëœ ìš”ì¼ ê¸°ë³¸ê°’ ì„¤ì • (ì˜¤ëŠ˜ ìš”ì¼)
            if (!selectedClassDay) {
                selectedClassDay = todayWeekDay;
            }

            const dayNames = { 'ì›”': 'ì›”ìš”ì¼', 'í™”': 'í™”ìš”ì¼', 'ìˆ˜': 'ìˆ˜ìš”ì¼', 'ëª©': 'ëª©ìš”ì¼', 'ê¸ˆ': 'ê¸ˆìš”ì¼', 'í† ': 'í† ìš”ì¼', 'ì¼': 'ì¼ìš”ì¼' };

            const waitingStudents = getWaitingStudents();
            const completedCount = todayAttendance.date === getTodayDateString() ? todayAttendance.records.length : 0;

            let html = `
                <div class="realtime-stats">
                    <div style="flex:1;display:flex;align-items:center;">
                        <span class="realtime-current-time">${currentTimeStr}</span>
                        <span class="realtime-current-date">${dateStr} (${todayWeekDay})</span>
                        <div class="day-selector">
                            <label>ìˆ˜ì—… ìš”ì¼:</label>
                            <select onchange="changeClassDay(this.value)">
                                <option value="ì›”" ${selectedClassDay === 'ì›”' ? 'selected' : ''}>ì›”ìš”ì¼${todayWeekDay === 'ì›”' ? ' (ì˜¤ëŠ˜)' : ''}</option>
                                <option value="í™”" ${selectedClassDay === 'í™”' ? 'selected' : ''}>í™”ìš”ì¼${todayWeekDay === 'í™”' ? ' (ì˜¤ëŠ˜)' : ''}</option>
                                <option value="ìˆ˜" ${selectedClassDay === 'ìˆ˜' ? 'selected' : ''}>ìˆ˜ìš”ì¼${todayWeekDay === 'ìˆ˜' ? ' (ì˜¤ëŠ˜)' : ''}</option>
                                <option value="ëª©" ${selectedClassDay === 'ëª©' ? 'selected' : ''}>ëª©ìš”ì¼${todayWeekDay === 'ëª©' ? ' (ì˜¤ëŠ˜)' : ''}</option>
                                <option value="ê¸ˆ" ${selectedClassDay === 'ê¸ˆ' ? 'selected' : ''}>ê¸ˆìš”ì¼${todayWeekDay === 'ê¸ˆ' ? ' (ì˜¤ëŠ˜)' : ''}</option>
                                <option value="í† " ${selectedClassDay === 'í† ' ? 'selected' : ''}>í† ìš”ì¼${todayWeekDay === 'í† ' ? ' (ì˜¤ëŠ˜)' : ''}</option>
                                <option value="ì¼" ${selectedClassDay === 'ì¼' ? 'selected' : ''}>ì¼ìš”ì¼${todayWeekDay === 'ì¼' ? ' (ì˜¤ëŠ˜)' : ''}</option>
                            </select>
                            ${selectedClassDay === todayWeekDay ? '<span class="today-badge">ì˜¤ëŠ˜</span>' : '<span style="font-size:12px;color:#e67e22;margin-left:5px;">(ë¯¸ë¦¬ë³´ê¸°)</span>'}
                        </div>
                    </div>
                    <div class="realtime-stat waiting">
                        <span class="realtime-stat-value">${waitingStudents.length}</span>
                        <span class="realtime-stat-label">ëŒ€ê¸°</span>
                    </div>
                    <div class="realtime-stat active">
                        <span class="realtime-stat-value">${activeSessions.length}</span>
                        <span class="realtime-stat-label">ìˆ˜ì—…ì¤‘</span>
                    </div>
                    <div class="realtime-stat completed">
                        <span class="realtime-stat-value">${completedCount}</span>
                        <span class="realtime-stat-label">ì™„ë£Œ</span>
                    </div>
                </div>

                <div class="realtime-container">
                    <div class="realtime-panel">
                        <div class="realtime-panel-header waiting">
                            ${dayNames[selectedClassDay]} ëŒ€ê¸° ì¤‘ (${waitingStudents.length}ëª…)
                        </div>
                        <div class="realtime-panel-body">
            `;

            if (waitingStudents.length === 0) {
                html += `<div class="no-students-message">${dayNames[selectedClassDay]}ì— ëŒ€ê¸° ì¤‘ì¸ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</div>`;
            } else {
                for (const student of waitingStudents) {
                    html += `
                        <div class="realtime-card grade-${student.grade}" onclick="checkInStudent('${student.name.replace(/'/g, "\\'")}', '${student.grade}', '${student.start}')">
                            <div class="card-header">
                                <span class="card-name">${student.name}</span>
                                <span class="grade-badge badge-${student.grade}">${student.grade}</span>
                            </div>
                            <div class="card-time">ì˜ˆì •: ${student.start}</div>
                            <div class="waiting-card-hint">í´ë¦­í•˜ì—¬ ìˆ˜ì—… ì‹œì‘</div>
                        </div>
                    `;
                }
            }

            // ì˜ˆì • ì™¸ í•™ìƒ ì¶”ê°€ ë²„íŠ¼
            html += `
                        <div class="add-extra-student" onclick="openExtraStudentModal()">
                            + ì˜ˆì • ì™¸ í•™ìƒ ì¶”ê°€
                        </div>
                    </div>
                </div>

                <div class="realtime-panel">
                    <div class="realtime-panel-header active">
                        ìˆ˜ì—… ì¤‘ (${activeSessions.length}ëª…)
                    </div>
                    <div class="realtime-panel-body">
            `;

            if (activeSessions.length === 0) {
                html += '<div class="no-students-message">ìˆ˜ì—… ì¤‘ì¸ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</div>';
            } else {
                // ë‚¨ì€ ì‹œê°„ ê¸°ì¤€ ì •ë ¬ (ì ê²Œ ë‚¨ì€ ìˆœ)
                const sortedSessions = [...activeSessions].sort((a, b) => {
                    return getRemainingSeconds(a.expectedEndTime) - getRemainingSeconds(b.expectedEndTime);
                });

                for (const session of sortedSessions) {
                    const remaining = getRemainingSeconds(session.expectedEndTime);
                    const isOvertime = remaining < 0;
                    const isWarning = remaining >= 0 && remaining <= 300;  // 5ë¶„ ì´í•˜

                    const checkInTime = new Date(session.checkInTime).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                    const expectedEndTime = new Date(session.expectedEndTime).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

                    let timerClass = '';
                    let cardClass = 'realtime-card checked-in grade-' + session.grade;
                    if (isOvertime) {
                        timerClass = 'overtime';
                        cardClass += ' overtime-card';
                    } else if (isWarning) {
                        timerClass = 'warning';
                    }

                    html += `
                        <div class="${cardClass}" data-student-card="${session.studentName}">
                            <div class="card-header">
                                <span class="card-name">${session.studentName}</span>
                                <span class="grade-badge badge-${session.grade}">${session.grade}</span>
                            </div>
                            <div class="card-time">
                                ì‹œì‘: ${checkInTime} â†’ ì¢…ë£Œ: ${expectedEndTime}
                                ${session.scheduledTime ? `<span style="color:#888;margin-left:10px;">(ì˜ˆì •: ${session.scheduledTime})</span>` : ''}
                            </div>
                            <div class="card-timer ${timerClass}" data-student-timer="${session.studentName}">
                                ${isOvertime ? 'âš ï¸ ì¢…ë£Œ! ' : ''}${formatRemainingTime(remaining)}
                            </div>
                            <div class="card-actions">
                                <button class="btn btn-extend btn-sm" onclick="extendSession('${session.studentName.replace(/'/g, "\\'")}')">+10ë¶„</button>
                                <button class="btn btn-danger btn-sm" onclick="checkOutStudent('${session.studentName.replace(/'/g, "\\'")}')">ì²´í¬ì•„ì›ƒ</button>
                            </div>
                        </div>
                    `;
                }
            }

            html += `
                    </div>
                </div>
            </div>
            `;

            document.getElementById('tableContainer').innerHTML = html;
        }

        // ì‹¤ì‹œê°„ íƒ€ì´ë¨¸ ì‹œì‘
        function startRealtimeTimer() {
            if (realtimeInterval) clearInterval(realtimeInterval);
            realtimeInterval = setInterval(() => {
                if (currentView === 'realtime') {
                    updateRealtimeTimers();  // ì „ì²´ ì¬ë Œë”ë§ ëŒ€ì‹  íƒ€ì´ë¨¸ë§Œ ì—…ë°ì´íŠ¸
                }
            }, 1000);  // 1ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
        }

        // íƒ€ì´ë¨¸ ë¶€ë¶„ë§Œ ì—…ë°ì´íŠ¸ (ë“œë¡­ë‹¤ìš´ ìœ ì§€)
        function updateRealtimeTimers() {
            // í˜„ì¬ ì‹œê° ì—…ë°ì´íŠ¸
            const timeEl = document.querySelector('.realtime-current-time');
            if (timeEl) {
                timeEl.textContent = getCurrentTimeString().slice(0, 5);
            }

            // ê° ì„¸ì…˜ì˜ íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸
            for (const session of activeSessions) {
                const remaining = getRemainingSeconds(session.expectedEndTime);
                const isOvertime = remaining < 0;
                const isWarning = remaining >= 0 && remaining <= 300;

                const timerEl = document.querySelector(`[data-student-timer="${session.studentName}"]`);
                if (timerEl) {
                    timerEl.textContent = (isOvertime ? 'âš ï¸ ì¢…ë£Œ! ' : '') + formatRemainingTime(remaining);

                    // í´ë˜ìŠ¤ ì—…ë°ì´íŠ¸
                    timerEl.classList.remove('warning', 'overtime');
                    if (isOvertime) {
                        timerEl.classList.add('overtime');
                    } else if (isWarning) {
                        timerEl.classList.add('warning');
                    }
                }

                // ì¹´ë“œ í´ë˜ìŠ¤ ì—…ë°ì´íŠ¸
                const cardEl = document.querySelector(`[data-student-card="${session.studentName}"]`);
                if (cardEl) {
                    if (isOvertime && !cardEl.classList.contains('overtime-card')) {
                        cardEl.classList.add('overtime-card');
                    }
                }
            }
        }

        // ì‹¤ì‹œê°„ íƒ€ì´ë¨¸ ì •ì§€
        function stopRealtimeTimer() {
            if (realtimeInterval) {
                clearInterval(realtimeInterval);
                realtimeInterval = null;
            }
        }

        // ì˜ˆì • ì™¸ í•™ìƒ ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
        function openExtraStudentModal() {
            // ì´ë¯¸ ì²´í¬ì¸ëœ í•™ìƒ ì œì™¸í•œ ì „ì²´ í•™ìƒ ëª©ë¡
            const checkedInNames = activeSessions.map(s => s.studentName);
            const availableStudents = [];
            const seenNames = new Set();

            for (const student of students) {
                if (!seenNames.has(student.name) && !checkedInNames.includes(student.name)) {
                    seenNames.add(student.name);
                    availableStudents.push(student);
                }
            }

            // í•™ë…„ìˆœ, ì´ë¦„ìˆœ ì •ë ¬
            availableStudents.sort((a, b) => {
                const gradeDiff = getGradeOrder(a.grade) - getGradeOrder(b.grade);
                if (gradeDiff !== 0) return gradeDiff;
                return a.name.localeCompare(b.name, 'ko');
            });

            let html = '<div style="max-height:400px;overflow-y:auto;">';
            if (availableStudents.length === 0) {
                html += '<div class="no-students-message">ì¶”ê°€í•  ìˆ˜ ìˆëŠ” í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</div>';
            } else {
                for (const student of availableStudents) {
                    html += `
                        <div class="realtime-card grade-${student.grade}" onclick="selectExtraStudent('${student.name.replace(/'/g, "\\'")}', '${student.grade}')" style="cursor:pointer;">
                            <div class="card-header">
                                <span class="card-name">${student.name}</span>
                                <span class="grade-badge badge-${student.grade}">${student.grade}</span>
                            </div>
                        </div>
                    `;
                }
            }
            html += '</div>';

            document.getElementById('extraStudentList').innerHTML = html;
            document.getElementById('extraStudentModal').classList.add('show');
        }

        // ì˜ˆì • ì™¸ í•™ìƒ ì„ íƒ
        function selectExtraStudent(name, grade) {
            closeExtraStudentModal();
            checkInStudent(name, grade, '');
        }

        // ì˜ˆì • ì™¸ í•™ìƒ ëª¨ë‹¬ ë‹«ê¸°
        function closeExtraStudentModal() {
            document.getElementById('extraStudentModal').classList.remove('show');
        }

        // ì¶œì„ ë°ì´í„° ì €ì¥
        async function saveAttendanceData() {
            const result = await window.electronAPI.saveAttendance(todayAttendance);
            if (!result.success) {
                console.error('ì¶œì„ ì €ì¥ ì‹¤íŒ¨:', result.error);
            }
        }

        // ì¶œì„ ë°ì´í„° ë¡œë“œ
        async function loadAttendanceData() {
            const today = getTodayDateString();
            const data = await window.electronAPI.loadAttendance(today);
            if (data && data.date === today) {
                todayAttendance = data;
            } else {
                todayAttendance = { date: today, records: [] };
            }
        }

        // ===== ì‹¤ì‹œê°„ ê´€ë¦¬ ê¸°ëŠ¥ ë =====

        function renderLinks(student) {
            let html = '';

            if (student.localFolder) {
                html += `<button class="link-btn folder" onclick="openFolder('${student.localFolder.replace(/'/g, "\\'")}')">ğŸ“ ìë£Œí´ë”</button>`;
            }

            student.driveLinks.forEach((link, i) => {
                const isFolder = link.includes('/folders/');
                const label = isFolder ? 'ğŸ“‚ Drive' : `ğŸ“„ ${i+1}`;
                html += `<button class="link-btn drive" onclick="openExternal('${link}')">${label}</button>`;
            });

            if (!student.localFolder && student.driveLinks.length === 0 && student.note) {
                html += '<span style="color:#999;font-size:11px;">êµì¬ì‚¬ìš©</span>';
            }

            return html || '-';
        }

        function renderTable(data) {
            if (data.length === 0) {
                return '<div class="no-data">í•´ë‹¹ ì¡°ê±´ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>ì´ë¦„</th>
                            <th>í•™ë…„</th>
                            <th>ìš”ì¼</th>
                            <th>ì‹œê°„</th>
                            <th>ë¹„ê³ </th>
                            <th>ê³¼ëª©</th>
                            <th>ìë£Œ</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach((s, idx) => {
                const originalIndex = students.indexOf(s);
                html += `
                    <tr class="${getGradeClass(s.grade)}">
                        <td class="student-name">${s.name}</td>
                        <td><span class="grade-badge badge-${s.grade}">${s.grade}</span></td>
                        <td class="day-${s.day}">${s.day}</td>
                        <td class="time">${s.start} ~ ${s.end}</td>
                        <td class="material-note">${s.note || '-'}</td>
                        <td><span class="subject-badge">${s.subject || '-'}</span></td>
                        <td class="links-cell">${renderLinks(s)}</td>
                        <td class="actions-cell">
                            <button class="btn btn-primary btn-sm" onclick="openEditModal(${originalIndex})">ìˆ˜ì •</button>
                            <button class="btn btn-danger btn-sm" onclick="confirmDelete(${originalIndex})">ì‚­ì œ</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            return html;
        }

        function render() {
            // ì‹¤ì‹œê°„ ê´€ë¦¬ ë³´ê¸°
            if (currentView === 'realtime') {
                renderRealtimeView();
                startRealtimeTimer();
                return;
            } else {
                stopRealtimeTimer();
            }

            // ì‹œê°„ëŒ€ë³„ ë³´ê¸°ëŠ” ë³„ë„ ë Œë”ë§
            if (currentView === 'timeslot') {
                document.getElementById('tableContainer').innerHTML = renderTimeSlotView();
                return;
            }

            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            let filtered = students.filter(s => s.name.toLowerCase().includes(searchTerm));

            // ìš”ì¼ í•„í„°
            if (currentDay !== 'all') {
                filtered = filtered.filter(s => s.day === currentDay);
            }

            // í•™ë…„ í•„í„°
            if (currentGrade !== 'all') {
                filtered = filtered.filter(s => s.grade === currentGrade);
            }

            // ì •ë ¬
            if (currentView === 'day') {
                // ìš”ì¼ë³„: ìš”ì¼ â†’ ì‹œê°„ìˆœ
                const dayOrder = ['í™”', 'ëª©', 'í† '];
                filtered.sort((a, b) => {
                    const dayDiff = dayOrder.indexOf(a.day) - dayOrder.indexOf(b.day);
                    if (dayDiff !== 0) return dayDiff;
                    return timeToMinutes(a.start) - timeToMinutes(b.start);
                });
            } else if (currentView === 'student') {
                // í•™ìƒë³„: í•™ë…„ â†’ ì´ë¦„ â†’ ìš”ì¼ìˆœ
                filtered.sort((a, b) => {
                    const gradeDiff = getGradeOrder(a.grade) - getGradeOrder(b.grade);
                    if (gradeDiff !== 0) return gradeDiff;
                    const nameDiff = a.name.localeCompare(b.name, 'ko');
                    if (nameDiff !== 0) return nameDiff;
                    const dayOrder = ['í™”', 'ëª©', 'í† '];
                    return dayOrder.indexOf(a.day) - dayOrder.indexOf(b.day);
                });
            } else if (currentView === 'grade') {
                // í•™ë…„ë³„: í•™ë…„ â†’ ì‹œê°„ìˆœ
                filtered.sort((a, b) => {
                    const gradeDiff = getGradeOrder(a.grade) - getGradeOrder(b.grade);
                    if (gradeDiff !== 0) return gradeDiff;
                    const dayOrder = ['í™”', 'ëª©', 'í† '];
                    const dayDiff = dayOrder.indexOf(a.day) - dayOrder.indexOf(b.day);
                    if (dayDiff !== 0) return dayDiff;
                    return timeToMinutes(a.start) - timeToMinutes(b.start);
                });
            }

            document.getElementById('tableContainer').innerHTML = renderTable(filtered);
        }

        // í´ë” ì—´ê¸°
        async function openFolder(folderName) {
            const result = await window.electronAPI.openFolder(folderName);
            if (!result.success) {
                showToast(result.error, true);
            }
        }

        // ì™¸ë¶€ ë§í¬ ì—´ê¸°
        async function openExternal(url) {
            await window.electronAPI.openExternal(url);
        }

        // ëª¨ë‹¬ ì—´ê¸° (ì¶”ê°€)
        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'í•™ìƒ ì¶”ê°€';
            document.getElementById('editIndex').value = -1;
            document.getElementById('studentForm').reset();
            resetDriveLinks();
            resetPdfList();
            document.getElementById('studentModal').classList.add('show');
        }

        // ëª¨ë‹¬ ì—´ê¸° (ìˆ˜ì •)
        function openEditModal(index) {
            const student = students[index];
            document.getElementById('modalTitle').textContent = 'í•™ìƒ ì •ë³´ ìˆ˜ì •';
            document.getElementById('editIndex').value = index;

            document.getElementById('formName').value = student.name;
            document.getElementById('formGrade').value = student.grade;
            document.getElementById('formDay').value = student.day;
            document.getElementById('formStart').value = student.start;
            document.getElementById('formEnd').value = student.end;
            document.getElementById('formSubject').value = student.subject || 'ì¤‘1ìˆ˜í•™';
            document.getElementById('formNote').value = student.note;
            document.getElementById('formLocalFolder').value = student.localFolder;

            // Drive ë§í¬ ì„¤ì •
            resetDriveLinks();
            student.driveLinks.forEach((link, i) => {
                if (i > 0) addDriveLink();
                const inputs = document.querySelectorAll('#driveLinksContainer input');
                inputs[i].value = link;
            });

            // PDF ëª©ë¡ ë¡œë“œ
            if (student.localFolder) {
                loadPdfList(student.localFolder);
            } else {
                resetPdfList();
            }

            document.getElementById('studentModal').classList.add('show');
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            document.getElementById('studentModal').classList.remove('show');
        }

        // Drive ë§í¬ ê´€ë¦¬
        function resetDriveLinks() {
            document.getElementById('driveLinksContainer').innerHTML = `
                <div class="drive-link-item">
                    <input type="url" placeholder="https://drive.google.com/...">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeDriveLink(this)">ì‚­ì œ</button>
                </div>
            `;
        }

        function addDriveLink() {
            const container = document.getElementById('driveLinksContainer');
            const div = document.createElement('div');
            div.className = 'drive-link-item';
            div.innerHTML = `
                <input type="url" placeholder="https://drive.google.com/...">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeDriveLink(this)">ì‚­ì œ</button>
            `;
            container.appendChild(div);
        }

        function removeDriveLink(btn) {
            const container = document.getElementById('driveLinksContainer');
            if (container.children.length > 1) {
                btn.parentElement.remove();
            } else {
                btn.previousElementSibling.value = '';
            }
        }

        // í¼ ì œì¶œ
        function submitForm(e) {
            e.preventDefault();

            const index = parseInt(document.getElementById('editIndex').value);
            const driveInputs = document.querySelectorAll('#driveLinksContainer input');
            const driveLinks = Array.from(driveInputs).map(i => i.value.trim()).filter(v => v);

            const studentData = {
                name: document.getElementById('formName').value.trim(),
                grade: document.getElementById('formGrade').value,
                day: document.getElementById('formDay').value,
                start: document.getElementById('formStart').value,
                end: document.getElementById('formEnd').value,
                subject: document.getElementById('formSubject').value,
                note: document.getElementById('formNote').value.trim(),
                localFolder: document.getElementById('formLocalFolder').value,
                driveLinks: driveLinks
            };

            if (index === -1) {
                students.push(studentData);
                showToast('í•™ìƒì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                students[index] = studentData;
                showToast('í•™ìƒ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }

            closeModal();
            render();
        }

        // ì‚­ì œ í™•ì¸
        function confirmDelete(index) {
            deleteIndex = index;
            const student = students[index];
            document.getElementById('deleteMessage').textContent =
                `"${student.name}" (${student.day} ${student.start}~${student.end}) ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
            document.getElementById('deleteModal').classList.add('show');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            deleteIndex = -1;
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
            if (deleteIndex !== -1) {
                students.splice(deleteIndex, 1);
                showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeDeleteModal();
                render();
            }
        });

        // PDF ê´€ë ¨ í•¨ìˆ˜ë“¤
        function resetPdfList() {
            document.getElementById('pdfList').innerHTML = '<div class="no-pdf">í´ë”ë¥¼ ì„ íƒí•˜ë©´ PDF ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤</div>';
        }

        // í˜„ì¬ ì„ íƒëœ í´ë”ëª… ì €ì¥
        let currentFolderName = '';

        // íŠ¸ë¦¬ êµ¬ì¡° ë Œë”ë§ í•¨ìˆ˜
        function renderFileTree(items, folderName, depth = 0) {
            let html = '';

            for (const item of items) {
                if (item.type === 'file') {
                    const escapedPath = item.path.replace(/'/g, "\\'").replace(/\\/g, '\\\\');
                    html += `
                        <div class="pdf-item">
                            <span class="pdf-item-name" title="${item.path}">ğŸ“„ ${item.name}</span>
                            <button class="btn btn-primary btn-sm" onclick="openPdf('${folderName.replace(/'/g, "\\'")}', '${escapedPath}')">ì—´ê¸°</button>
                            <button class="btn btn-danger btn-sm" onclick="deletePdf('${folderName.replace(/'/g, "\\'")}', '${escapedPath}')">ì‚­ì œ</button>
                        </div>
                    `;
                } else if (item.type === 'folder') {
                    const folderId = `folder-${depth}-${item.name.replace(/\s/g, '-')}`;
                    html += `
                        <div class="pdf-folder">
                            <div class="pdf-folder-header" onclick="toggleFolder('${folderId}')">
                                <span class="folder-icon">â–¼</span>
                                ğŸ“ ${item.name}
                                <span style="color:#888;font-size:11px;margin-left:auto;">(${countFiles(item.children)}ê°œ)</span>
                            </div>
                            <div class="pdf-folder-children" id="${folderId}">
                                ${renderFileTree(item.children, folderName, depth + 1)}
                            </div>
                        </div>
                    `;
                }
            }

            return html;
        }

        // í´ë” ë‚´ íŒŒì¼ ìˆ˜ ê³„ì‚°
        function countFiles(items) {
            let count = 0;
            for (const item of items) {
                if (item.type === 'file') {
                    count++;
                } else if (item.type === 'folder') {
                    count += countFiles(item.children);
                }
            }
            return count;
        }

        // í´ë” í† ê¸€
        function toggleFolder(folderId) {
            const children = document.getElementById(folderId);
            const header = children.previousElementSibling;
            children.classList.toggle('hidden');
            header.classList.toggle('collapsed');
        }

        async function loadPdfList(folderName) {
            const pdfList = document.getElementById('pdfList');
            currentFolderName = folderName;

            if (!folderName) {
                pdfList.innerHTML = '<div class="no-pdf">í´ë”ë¥¼ ì„ íƒí•˜ë©´ PDF ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤</div>';
                return;
            }

            const files = await window.electronAPI.getStudentFiles(folderName);

            if (files.length === 0) {
                pdfList.innerHTML = '<div class="no-pdf">PDF íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€í•˜ì„¸ìš”.</div>';
                return;
            }

            const totalCount = countFiles(files);
            pdfList.innerHTML = `
                <div style="font-size:12px;color:#666;margin-bottom:8px;">ì´ ${totalCount}ê°œ íŒŒì¼</div>
                ${renderFileTree(files, folderName)}
            `;
        }

        async function selectAndUploadPdf() {
            const folderSelect = document.getElementById('formLocalFolder');
            const studentName = document.getElementById('formName').value.trim();
            let folderName = folderSelect.value;

            // í´ë”ê°€ ì—†ìœ¼ë©´ í•™ìƒ ì´ë¦„ìœ¼ë¡œ ìƒˆ í´ë” ìƒì„±
            if (!folderName) {
                if (!studentName) {
                    showToast('ë¨¼ì € í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.', true);
                    return;
                }
                folderName = studentName;
            }

            // íŒŒì¼ ì„ íƒ
            const result = await window.electronAPI.selectPdfFiles();
            if (!result.success || result.canceled) {
                return;
            }

            // íŒŒì¼ ì—…ë¡œë“œ
            const uploadResult = await window.electronAPI.uploadPdf({
                filePaths: result.filePaths,
                studentName: folderName
            });

            if (uploadResult.success) {
                showToast(`${uploadResult.copiedFiles.length}ê°œ íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ!`);

                // í´ë” ëª©ë¡ ê°±ì‹ 
                folders = await window.electronAPI.getFolders();
                updateFolderSelect();

                // í´ë” ì„ íƒ ë° PDF ëª©ë¡ ê°±ì‹ 
                folderSelect.value = uploadResult.folderName;
                loadPdfList(uploadResult.folderName);
            } else {
                showToast('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + uploadResult.error, true);
            }
        }

        async function createNewFolder() {
            const studentName = document.getElementById('formName').value.trim();
            if (!studentName) {
                showToast('ë¨¼ì € í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.', true);
                return;
            }

            // ë¹ˆ íŒŒì¼ë¡œ í´ë” ìƒì„± (ì—…ë¡œë“œ ì‹œ ìë™ ìƒì„±ë¨)
            const result = await window.electronAPI.selectPdfFiles();
            if (!result.success || result.canceled) {
                return;
            }

            const uploadResult = await window.electronAPI.uploadPdf({
                filePaths: result.filePaths,
                studentName: studentName
            });

            if (uploadResult.success) {
                showToast(`"${studentName}" í´ë” ìƒì„± ë° ${uploadResult.copiedFiles.length}ê°œ íŒŒì¼ ì—…ë¡œë“œ!`);
                folders = await window.electronAPI.getFolders();
                updateFolderSelect();
                document.getElementById('formLocalFolder').value = studentName;
                loadPdfList(studentName);
            } else {
                showToast('í´ë” ìƒì„± ì‹¤íŒ¨: ' + uploadResult.error, true);
            }
        }

        async function openPdf(folderName, filePath) {
            const result = await window.electronAPI.openPdf({ folderName, filePath });
            if (!result.success) {
                showToast(result.error, true);
            }
        }

        async function deletePdf(folderName, filePath) {
            const fileName = filePath.split(/[/\\]/).pop();
            if (!confirm(`"${fileName}" íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            const result = await window.electronAPI.deletePdf({ folderName, filePath });
            if (result.success) {
                showToast('íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadPdfList(folderName);
            } else {
                showToast('ì‚­ì œ ì‹¤íŒ¨: ' + result.error, true);
            }
        }

        // PDF ë©”íƒ€ë°ì´í„°ë¥¼ Notionì— ë™ê¸°í™”
        async function syncPdfsToNotion() {
            if (!notionConnected) {
                showToast('ë¨¼ì € Notionì— ì—°ê²°í•˜ì„¸ìš”.', true);
                return;
            }

            const folderName = document.getElementById('formLocalFolder').value;
            const studentName = document.getElementById('formName').value.trim();
            const subject = document.getElementById('formSubject').value;

            if (!folderName) {
                showToast('ë¨¼ì € í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”.', true);
                return;
            }

            // PDF DB ì„¤ì • í™•ì¸
            const config = await window.electronAPI.notionGetConfig();
            if (!config?.databases?.pdfs) {
                showToast('Notion ì„¤ì •ì—ì„œ PDF DB IDë¥¼ ë¨¼ì € ì„¤ì •í•˜ì„¸ìš”.', true);
                return;
            }

            // ë¡œì»¬ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            const files = await window.electronAPI.getStudentFiles(folderName);
            const localFiles = flattenFileTree(files);

            if (localFiles.length === 0) {
                showToast('ë™ê¸°í™”í•  PDF íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.', true);
                return;
            }

            showToast(`${localFiles.length}ê°œ íŒŒì¼ ë©”íƒ€ë°ì´í„°ë¥¼ Notionì— ì €ì¥ ì¤‘...`);

            // ê³¼ëª© ì •ë³´ ì¶”ê°€
            const filesWithSubject = localFiles.map(f => ({
                ...f,
                subject: subject
            }));

            // Notionì— ë©”íƒ€ë°ì´í„° ì €ì¥
            const result = await window.electronAPI.notionSyncPdfs({
                studentName: studentName || folderName,
                files: filesWithSubject
            });

            if (result.success) {
                showToast(`${result.added}ê°œ íŒŒì¼ ë©”íƒ€ë°ì´í„°ê°€ Notionì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. Notionì—ì„œ PDFë¥¼ ì§ì ‘ ì²¨ë¶€í•˜ì„¸ìš”!`);
            } else {
                showToast('Notion ì €ì¥ ì‹¤íŒ¨: ' + result.error, true);
            }
        }

        // íŒŒì¼ íŠ¸ë¦¬ë¥¼ í‰íƒ„í™”í•˜ì—¬ íŒŒì¼ ëª©ë¡ë§Œ ì¶”ì¶œ
        function flattenFileTree(items, basePath = '') {
            let files = [];
            for (const item of items) {
                if (item.type === 'file') {
                    files.push({
                        fileName: item.name,
                        localPath: item.path
                    });
                } else if (item.type === 'folder') {
                    files = files.concat(flattenFileTree(item.children, item.path));
                }
            }
            return files;
        }

        // í´ë” ì„ íƒ ë³€ê²½ ì‹œ PDF ëª©ë¡ ê°±ì‹ 
        document.getElementById('formLocalFolder').addEventListener('change', (e) => {
            loadPdfList(e.target.value);
        });

        // ë°ì´í„° ì €ì¥
        async function saveAllData() {
            const result = await window.electronAPI.saveData({ students });
            if (result.success) {
                showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } else {
                showToast('ì €ì¥ ì‹¤íŒ¨: ' + result.error, true);
            }
        }

        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show' + (isError ? ' error' : '');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // íƒ­ ì´ë²¤íŠ¸
        document.querySelectorAll('.view-tabs .tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.view-tabs .tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentView = tab.dataset.view;
                render();
            });
        });

        document.querySelectorAll('.day-tabs .tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.day-tabs .tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentDay = tab.dataset.day;
                render();
            });
        });

        document.querySelectorAll('.grade-tabs .tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.grade-tabs .tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentGrade = tab.dataset.grade;
                render();
            });
        });

        // ===== Notion ì—°ë™ ê¸°ëŠ¥ =====

        let notionConnected = false;

        // Notion ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
        async function openNotionSettingsModal() {
            document.getElementById('notionModal').classList.add('show');

            // ì €ì¥ëœ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
            const config = await window.electronAPI.notionGetConfig();
            if (config) {
                document.getElementById('notionApiKey').value = config.apiKey || '';
                document.getElementById('notionStudentsDb').value = config.databases?.students || '';
                document.getElementById('notionAttendanceDb').value = config.databases?.attendance || '';
                document.getElementById('notionPdfsDb').value = config.databases?.pdfs || '';
            }

            // ì—°ê²° ìƒíƒœ í™•ì¸
            await checkNotionStatus();
        }

        // Notion ëª¨ë‹¬ ë‹«ê¸°
        function closeNotionModal() {
            document.getElementById('notionModal').classList.remove('show');
        }

        // Notion ì—°ê²° ìƒíƒœ í™•ì¸
        async function checkNotionStatus() {
            const statusEl = document.getElementById('notionStatus');
            statusEl.innerHTML = 'ì—°ê²° ìƒíƒœ í™•ì¸ ì¤‘...';
            statusEl.style.background = '#f8f9fa';

            const result = await window.electronAPI.notionTestConnection();
            if (result.success) {
                statusEl.innerHTML = `âœ… ì—°ê²°ë¨: ${result.user}`;
                statusEl.style.background = '#d4edda';
                notionConnected = true;
                updateNotionButton(true);
            } else {
                statusEl.innerHTML = `âŒ ì—°ê²° ì•ˆë¨: ${result.error}`;
                statusEl.style.background = '#f8d7da';
                notionConnected = false;
                updateNotionButton(false);
            }
        }

        // Notion ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateNotionButton(connected) {
            const btn = document.getElementById('notionBtn');
            if (connected) {
                btn.style.background = '#27ae60';
                btn.textContent = 'â˜ï¸ Notion âœ“';
            } else {
                btn.style.background = '#444';
                btn.textContent = 'â˜ï¸ Notion';
            }
        }

        // Notion ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testNotionConnection() {
            // ë¨¼ì € ì„¤ì • ì €ì¥
            await saveNotionSettingsQuiet();
            await checkNotionStatus();
        }

        // Notion ì„¤ì • ì €ì¥ (ì¡°ìš©íˆ)
        async function saveNotionSettingsQuiet() {
            const apiKey = document.getElementById('notionApiKey').value.trim();
            const studentsDb = extractDatabaseId(document.getElementById('notionStudentsDb').value.trim());
            const attendanceDb = extractDatabaseId(document.getElementById('notionAttendanceDb').value.trim());
            const pdfsDb = extractDatabaseId(document.getElementById('notionPdfsDb').value.trim());

            await window.electronAPI.notionSaveConfig({
                apiKey,
                databases: {
                    students: studentsDb,
                    attendance: attendanceDb,
                    pdfs: pdfsDb
                }
            });
        }

        // Notion ì„¤ì • ì €ì¥
        async function saveNotionSettings() {
            await saveNotionSettingsQuiet();
            showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            await checkNotionStatus();
        }

        // URLì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ ID ì¶”ì¶œ
        function extractDatabaseId(input) {
            if (!input) return '';

            // ì´ë¯¸ 32ìë¦¬ IDë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
            if (/^[a-f0-9]{32}$/i.test(input.replace(/-/g, ''))) {
                return input.replace(/-/g, '');
            }

            // URLì—ì„œ ID ì¶”ì¶œ
            const match = input.match(/([a-f0-9]{32})/i);
            if (match) return match[1];

            // í•˜ì´í”ˆ í¬í•¨ëœ í˜•ì‹
            const match2 = input.match(/([a-f0-9-]{36})/i);
            if (match2) return match2[1].replace(/-/g, '');

            return input;
        }

        // Notionì—ì„œ í•™ìƒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function syncFromNotion() {
            showToast('Notionì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...');

            const result = await window.electronAPI.notionGetStudents();
            if (result.success) {
                if (result.students.length === 0) {
                    showToast('Notionì— í•™ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', true);
                    return;
                }

                // ê¸°ì¡´ ë°ì´í„°ì™€ ë³‘í•©í• ì§€ í™•ì¸
                if (students.length > 0) {
                    if (!confirm(`í˜„ì¬ ${students.length}ëª…ì˜ í•™ìƒ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤.\nNotionì—ì„œ ê°€ì ¸ì˜¨ ${result.students.length}ëª…ì˜ ë°ì´í„°ë¡œ ëŒ€ì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        return;
                    }
                }

                students = result.students;
                render();
                showToast(`Notionì—ì„œ ${result.students.length}ëª…ì˜ í•™ìƒ ë°ì´í„°ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.`);
            } else {
                showToast('Notion ë™ê¸°í™” ì‹¤íŒ¨: ' + result.error, true);
            }
        }

        // ì²´í¬ì•„ì›ƒ ì‹œ Notionì— ì¶œì„ ê¸°ë¡ ì¶”ê°€
        async function syncAttendanceToNotion(record) {
            if (!notionConnected) return;

            const config = await window.electronAPI.notionGetConfig();
            if (!config.databases?.attendance) return;

            const result = await window.electronAPI.notionAddAttendance({
                ...record,
                date: getTodayDateString()
            });

            if (result.success) {
                console.log('Notion ì¶œì„ ê¸°ë¡ ì¶”ê°€ ì™„ë£Œ');
            } else {
                console.error('Notion ì¶œì„ ê¸°ë¡ ì‹¤íŒ¨:', result.error);
            }
        }

        // ì•± ì‹œì‘ ì‹œ Notion ì—°ê²° í™•ì¸
        async function initNotion() {
            const config = await window.electronAPI.notionGetConfig();
            if (config && config.apiKey) {
                const result = await window.electronAPI.notionTestConnection();
                notionConnected = result.success;
                updateNotionButton(result.success);
            }
        }

        // ===== Notion ì—°ë™ ê¸°ëŠ¥ ë =====

        // ===== AI ë¹„ì„œ ê¸°ëŠ¥ =====

        let aiConnected = false;

        // AI ëª¨ë‹¬ ì—´ê¸°
        async function openAiChat() {
            document.getElementById('aiModal').classList.add('show');
            await checkAiStatus();
        }

        // AI ëª¨ë‹¬ ë‹«ê¸°
        function closeAiModal() {
            document.getElementById('aiModal').classList.remove('show');
        }

        // AI ì—°ê²° ìƒíƒœ í™•ì¸
        async function checkAiStatus() {
            const statusEl = document.getElementById('aiStatus');
            statusEl.innerHTML = 'ì—°ê²° ìƒíƒœ í™•ì¸ ì¤‘...';
            statusEl.style.background = '#f8f9fa';
            statusEl.style.color = '#666';

            const config = await window.electronAPI.aiGetConfig();

            if (!config.hasAnthropicKey && !config.hasOpenaiKey && !config.hasGoogleKey) {
                statusEl.innerHTML = 'âš ï¸ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. .env íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.';
                statusEl.style.background = '#fff3cd';
                statusEl.style.color = '#856404';
                aiConnected = false;
                updateAiButton(false);
                return;
            }

            const result = await window.electronAPI.aiTest();
            if (result.success) {
                statusEl.innerHTML = `âœ… ì—°ê²°ë¨ (${result.provider})`;
                statusEl.style.background = '#d4edda';
                statusEl.style.color = '#155724';
                aiConnected = true;
                updateAiButton(true);
            } else {
                statusEl.innerHTML = `âŒ ì—°ê²° ì‹¤íŒ¨: ${result.error}`;
                statusEl.style.background = '#f8d7da';
                statusEl.style.color = '#721c24';
                aiConnected = false;
                updateAiButton(false);
            }
        }

        // AI ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateAiButton(connected) {
            const btn = document.getElementById('aiBtn');
            if (connected) {
                btn.style.background = '#27ae60';
                btn.textContent = 'ğŸ¤– AI ë¹„ì„œ âœ“';
            } else {
                btn.style.background = '#8e44ad';
                btn.textContent = 'ğŸ¤– AI ë¹„ì„œ';
            }
        }

        // AI ë©”ì‹œì§€ ì „ì†¡
        async function sendAiMessage() {
            const input = document.getElementById('aiInput');
            const message = input.value.trim();

            if (!message) return;

            if (!aiConnected) {
                showToast('AIê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. .env íŒŒì¼ì— API í‚¤ë¥¼ ì„¤ì •í•˜ì„¸ìš”.', true);
                return;
            }

            // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
            addAiMessage(message, 'user');
            input.value = '';

            // ë¡œë”© í‘œì‹œ
            const loadingEl = addAiMessage('ìƒê° ì¤‘...', 'loading');

            // ì»¨í…ìŠ¤íŠ¸ ì¤€ë¹„ (í˜„ì¬ í•™ìƒ ë°ì´í„°, ì˜¤ëŠ˜ ì¼ì • ë“±)
            const today = new Date();
            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            const todayDay = dayNames[today.getDay()];

            const todaySchedule = students.filter(s => s.day === todayDay);

            const context = {
                students: students,
                todaySchedule: todaySchedule,
                today: today.toLocaleDateString('ko-KR'),
                todayDay: todayDay
            };

            // AI ìš”ì²­
            const result = await window.electronAPI.aiChat({ message, context });

            // ë¡œë”© ì œê±°
            loadingEl.remove();

            if (result.success) {
                addAiMessage(result.message, 'assistant');
            } else {
                addAiMessage(`ì˜¤ë¥˜: ${result.error}`, 'assistant');
            }
        }

        // ì±„íŒ… ë©”ì‹œì§€ ì¶”ê°€
        function addAiMessage(text, type) {
            const container = document.getElementById('aiChatMessages');
            const div = document.createElement('div');
            div.className = `ai-message ai-${type}`;
            div.innerHTML = text.replace(/\n/g, '<br>');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return div;
        }

        // ëŒ€í™” ì´ˆê¸°í™”
        async function clearAiChat() {
            await window.electronAPI.aiClearHistory();
            const container = document.getElementById('aiChatMessages');
            container.innerHTML = `
                <div class="ai-message ai-assistant">
                    ëŒ€í™”ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”! ğŸ”„<br><br>
                    <b>ì§ˆë¬¸ ì˜ˆì‹œ:</b><br>
                    ğŸ“… "ì˜¤ëŠ˜ ìˆ˜ì—… ì¼ì • ì•Œë ¤ì¤˜"<br>
                    ğŸ‘¨â€ğŸ“ "ì¤‘2 í•™ìƒ ëª©ë¡ ë³´ì—¬ì¤˜"<br>
                    ğŸ“ "í™ê¸¸ë™ í•™ìƒ ì •ë³´ ì•Œë ¤ì¤˜"
                </div>
            `;
            showToast('ëŒ€í™”ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // AI ì´ˆê¸°í™”
        async function initAi() {
            const config = await window.electronAPI.aiGetConfig();
            if (config.hasAnthropicKey || config.hasOpenaiKey || config.hasGoogleKey) {
                const result = await window.electronAPI.aiTest();
                aiConnected = result.success;
                updateAiButton(result.success);
            }
        }

        // ===== AI ë¹„ì„œ ê¸°ëŠ¥ ë =====

        // ì„¤ì • ì°½ ì—´ê¸°
        async function openSettings() {
            await window.electronAPI.openSettings();
        }

        // ì•± ë²„ì „ í‘œì‹œ
        async function showVersion() {
            const version = await window.electronAPI.getAppVersion();
            document.getElementById('appVersion').textContent = `v${version}`;
        }

        // ì•± ì´ˆê¸°í™”
        init();
        initNotion();
        initAi();
        showVersion();
    </script>

    <!-- ë²„ì „ í‘œì‹œ -->
    <div id="appVersion" style="position:fixed;bottom:10px;right:15px;font-size:11px;color:#aaa;z-index:1;"></div>
</body>
</html>
