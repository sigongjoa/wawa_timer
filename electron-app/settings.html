<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„¤ì • - ìˆ˜í•™ì‹œê°„í‘œê´€ë¦¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #5a67d8 0%, #7c3aed 100%);
            color: white;
            padding: 24px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .header .version {
            font-size: 14px;
            opacity: 0.8;
        }

        .content {
            padding: 24px;
        }

        .section {
            margin-bottom: 28px;
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            color: #374151;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title .icon {
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 6px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #7c3aed;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }

        .form-group input::placeholder {
            color: #9ca3af;
        }

        .form-group .hint {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 4px;
        }

        .radio-group {
            display: flex;
            gap: 16px;
            margin-top: 8px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .radio-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .btn-row {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #7c3aed 0%, #5a67d8 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .status {
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px;
            margin-top: 12px;
            display: none;
        }

        .status.success {
            display: block;
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .status.error {
            display: block;
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .status.info {
            display: block;
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }

        .footer {
            padding: 20px 24px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer .btn-save {
            padding: 12px 32px;
            font-size: 16px;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .db-ids {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            margin-top: 12px;
        }

        .db-ids .form-group {
            margin-bottom: 12px;
        }

        .db-ids .form-group:last-child {
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ì„¤ì •</h1>
            <div class="version" id="appVersion">ë²„ì „ ë¡œë”© ì¤‘...</div>
        </div>

        <div class="content">
            <!-- Notion ì„¤ì • -->
            <div class="section">
                <div class="section-title">
                    <span class="icon">ğŸ“</span>
                    Notion ì—°ë™ ì„¤ì •
                </div>

                <div class="form-group">
                    <label for="notionApiKey">Notion API í‚¤</label>
                    <input type="password" id="notionApiKey" placeholder="ntn_xxxxx...">
                    <div class="hint">Notion Integrationsì—ì„œ ë°œê¸‰ë°›ì€ Internal Integration Token</div>
                </div>

                <div class="db-ids">
                    <div class="form-group">
                        <label for="dbStudents">í•™ìƒ ë°ì´í„°ë² ì´ìŠ¤ ID</label>
                        <input type="text" id="dbStudents" placeholder="32ìë¦¬ ë°ì´í„°ë² ì´ìŠ¤ ID">
                    </div>
                    <div class="form-group">
                        <label for="dbAttendance">ì¶œì„ ë°ì´í„°ë² ì´ìŠ¤ ID</label>
                        <input type="text" id="dbAttendance" placeholder="32ìë¦¬ ë°ì´í„°ë² ì´ìŠ¤ ID">
                    </div>
                    <div class="form-group">
                        <label for="dbPdfs">PDF ë°ì´í„°ë² ì´ìŠ¤ ID</label>
                        <input type="text" id="dbPdfs" placeholder="32ìë¦¬ ë°ì´í„°ë² ì´ìŠ¤ ID">
                    </div>
                </div>

                <div class="btn-row">
                    <button class="btn btn-secondary" onclick="testNotion()">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
                </div>
                <div class="status" id="notionStatus"></div>
            </div>

            <!-- AI ì„¤ì • -->
            <div class="section">
                <div class="section-title">
                    <span class="icon">ğŸ¤–</span>
                    AI ë¹„ì„œ ì„¤ì •
                </div>

                <div class="form-group">
                    <label>AI ì œê³µì ì„ íƒ</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="aiProvider" value="anthropic" checked>
                            Claude (Anthropic)
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="aiProvider" value="openai">
                            GPT (OpenAI)
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="aiProvider" value="google">
                            Gemini (Google)
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="anthropicKey">Anthropic API í‚¤</label>
                    <input type="password" id="anthropicKey" placeholder="sk-ant-xxxxx...">
                </div>

                <div class="form-group">
                    <label for="openaiKey">OpenAI API í‚¤</label>
                    <input type="password" id="openaiKey" placeholder="sk-xxxxx...">
                </div>

                <div class="form-group">
                    <label for="googleKey">Google AI API í‚¤</label>
                    <input type="password" id="googleKey" placeholder="AIza...">
                </div>

                <div class="btn-row">
                    <button class="btn btn-secondary" onclick="testAI()">AI ì—°ê²° í…ŒìŠ¤íŠ¸</button>
                </div>
                <div class="status" id="aiStatus"></div>
            </div>

            <!-- P5S ì›Œì¹˜ ì„¤ì • -->
            <div class="section">
                <div class="section-title">
                    <span class="icon">âŒš</span>
                    P5S ì›Œì¹˜ ì•Œë¦¼ ì„¤ì •
                </div>

                <div class="form-group">
                    <label for="watchEnabled">ì›Œì¹˜ ì•Œë¦¼ ì‚¬ìš©</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="watchEnabled" value="true">
                            ì‚¬ìš©
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="watchEnabled" value="false" checked>
                            ì‚¬ìš© ì•ˆí•¨
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="watchMac">ì›Œì¹˜ MAC ì£¼ì†Œ</label>
                    <input type="text" id="watchMac" placeholder="01:BC:8D:DB:2C:15">
                    <div class="hint">P5S ì›Œì¹˜ì˜ Bluetooth MAC ì£¼ì†Œ (BLE ìŠ¤ìº”ìœ¼ë¡œ í™•ì¸)</div>
                </div>

                <div class="form-group">
                    <label for="watchWarningMin">ê²½ê³  ì•Œë¦¼ (ë¶„ ì „)</label>
                    <input type="number" id="watchWarningMin" value="5" min="1" max="30" style="width:100px;">
                    <div class="hint">ìˆ˜ì—… ì¢…ë£Œ Në¶„ ì „ì— ì›Œì¹˜ë¡œ ì•Œë¦¼</div>
                </div>

                <div class="btn-row">
                    <button class="btn btn-secondary" onclick="scanWatch()">ì›Œì¹˜ ê²€ìƒ‰</button>
                    <button class="btn btn-secondary" onclick="testWatch()">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
                </div>
                <div class="status" id="watchStatus"></div>
            </div>
        </div>

        <div class="footer">
            <button class="btn btn-secondary" onclick="window.close()">ì·¨ì†Œ</button>
            <button class="btn btn-primary btn-save" onclick="saveSettings()">ì €ì¥</button>
        </div>
    </div>

    <script>
        // ì„¤ì • ë¡œë“œ
        async function loadSettings() {
            try {
                // ë²„ì „ í‘œì‹œ
                const version = await window.settingsAPI.getVersion();
                document.getElementById('appVersion').textContent = `ë²„ì „ ${version}`;

                // Notion ì„¤ì • ë¡œë“œ
                const notionConfig = await window.settingsAPI.getNotionConfig();
                if (notionConfig) {
                    document.getElementById('notionApiKey').value = notionConfig.apiKey || '';
                    if (notionConfig.databases) {
                        document.getElementById('dbStudents').value = notionConfig.databases.students || '';
                        document.getElementById('dbAttendance').value = notionConfig.databases.attendance || '';
                        document.getElementById('dbPdfs').value = notionConfig.databases.pdfs || '';
                    }
                }

                // AI ì„¤ì • ë¡œë“œ
                const aiConfig = await window.settingsAPI.getAIConfig();
                if (aiConfig) {
                    const provider = aiConfig.provider || 'anthropic';
                    document.querySelector(`input[name="aiProvider"][value="${provider}"]`).checked = true;
                    document.getElementById('anthropicKey').value = aiConfig.anthropicKey || '';
                    document.getElementById('openaiKey').value = aiConfig.openaiKey || '';
                    document.getElementById('googleKey').value = aiConfig.googleKey || '';
                }

                // ì›Œì¹˜ ì„¤ì • ë¡œë“œ
                const watchConfig = await window.settingsAPI.getWatchConfig();
                if (watchConfig) {
                    const enabled = watchConfig.enabled ? 'true' : 'false';
                    document.querySelector(`input[name="watchEnabled"][value="${enabled}"]`).checked = true;
                    document.getElementById('watchMac').value = watchConfig.macAddress || '';
                    document.getElementById('watchWarningMin').value = watchConfig.warningMinutes || 5;
                }
            } catch (err) {
                console.error('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', err);
            }
        }

        // Notion ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testNotion() {
            const statusEl = document.getElementById('notionStatus');
            statusEl.className = 'status info';
            statusEl.textContent = 'ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...';

            try {
                const config = {
                    apiKey: document.getElementById('notionApiKey').value,
                    databases: {
                        students: document.getElementById('dbStudents').value,
                        attendance: document.getElementById('dbAttendance').value,
                        pdfs: document.getElementById('dbPdfs').value
                    }
                };

                const result = await window.settingsAPI.testNotion(config);
                if (result.success) {
                    statusEl.className = 'status success';
                    statusEl.textContent = 'ì—°ê²° ì„±ê³µ! Notion ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = 'ì—°ê²° ì‹¤íŒ¨: ' + result.error;
                }
            } catch (err) {
                statusEl.className = 'status error';
                statusEl.textContent = 'í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + err.message;
            }
        }

        // AI ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testAI() {
            const statusEl = document.getElementById('aiStatus');
            statusEl.className = 'status info';
            statusEl.textContent = 'AI ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...';

            try {
                const provider = document.querySelector('input[name="aiProvider"]:checked').value;
                const config = {
                    provider,
                    anthropicKey: document.getElementById('anthropicKey').value,
                    openaiKey: document.getElementById('openaiKey').value,
                    googleKey: document.getElementById('googleKey').value
                };

                const result = await window.settingsAPI.testAI(config);
                if (result.success) {
                    statusEl.className = 'status success';
                    statusEl.textContent = `AI ì—°ê²° ì„±ê³µ! (${provider})`;
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = 'ì—°ê²° ì‹¤íŒ¨: ' + result.error;
                }
            } catch (err) {
                statusEl.className = 'status error';
                statusEl.textContent = 'í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + err.message;
            }
        }

        // ì›Œì¹˜ ê²€ìƒ‰
        async function scanWatch() {
            const statusEl = document.getElementById('watchStatus');
            statusEl.className = 'status info';
            statusEl.textContent = 'ì›Œì¹˜ ê²€ìƒ‰ ì¤‘... (10ì´ˆ)';

            try {
                const result = await window.settingsAPI.scanWatch();
                if (result.success && result.devices && result.devices.length > 0) {
                    statusEl.className = 'status success';
                    let msg = 'ë°œê²¬ëœ ê¸°ê¸°:\n';
                    for (const d of result.devices) {
                        msg += `â€¢ ${d.name || '(ì´ë¦„ ì—†ìŒ)'} - ${d.address}\n`;
                    }
                    statusEl.innerHTML = msg.replace(/\n/g, '<br>');
                    // ì²« ë²ˆì§¸ ê¸°ê¸° ìë™ ì…ë ¥
                    if (result.devices[0]) {
                        document.getElementById('watchMac').value = result.devices[0].address;
                    }
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = 'ì›Œì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì›Œì¹˜ê°€ ì¼œì ¸ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.';
                }
            } catch (err) {
                statusEl.className = 'status error';
                statusEl.textContent = 'ê²€ìƒ‰ ì‹¤íŒ¨: ' + err.message;
            }
        }

        // ì›Œì¹˜ ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testWatch() {
            const statusEl = document.getElementById('watchStatus');
            const macAddress = document.getElementById('watchMac').value;

            if (!macAddress) {
                statusEl.className = 'status error';
                statusEl.textContent = 'MAC ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”';
                return;
            }

            statusEl.className = 'status info';
            statusEl.textContent = 'ì›Œì¹˜ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...';

            try {
                const result = await window.settingsAPI.testWatch(macAddress);
                if (result.success) {
                    statusEl.className = 'status success';
                    statusEl.textContent = 'ì›Œì¹˜ ì—°ê²° ì„±ê³µ! ì•Œë¦¼ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.';
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = 'ì—°ê²° ì‹¤íŒ¨: ' + (result.error || 'ì›Œì¹˜ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
            } catch (err) {
                statusEl.className = 'status error';
                statusEl.textContent = 'í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + err.message;
            }
        }

        // ì„¤ì • ì €ì¥
        async function saveSettings() {
            const statusEl = document.getElementById('notionStatus');

            try {
                // Notion ì„¤ì • ì €ì¥
                const notionConfig = {
                    apiKey: document.getElementById('notionApiKey').value,
                    databases: {
                        students: document.getElementById('dbStudents').value,
                        attendance: document.getElementById('dbAttendance').value,
                        pdfs: document.getElementById('dbPdfs').value
                    }
                };
                await window.settingsAPI.saveNotionConfig(notionConfig);

                // AI ì„¤ì • ì €ì¥
                const aiConfig = {
                    provider: document.querySelector('input[name="aiProvider"]:checked').value,
                    anthropicKey: document.getElementById('anthropicKey').value,
                    openaiKey: document.getElementById('openaiKey').value,
                    googleKey: document.getElementById('googleKey').value
                };
                await window.settingsAPI.saveAIConfig(aiConfig);

                // ì›Œì¹˜ ì„¤ì • ì €ì¥
                const watchConfig = {
                    enabled: document.querySelector('input[name="watchEnabled"]:checked').value === 'true',
                    macAddress: document.getElementById('watchMac').value,
                    warningMinutes: parseInt(document.getElementById('watchWarningMin').value) || 5
                };
                await window.settingsAPI.saveWatchConfig(watchConfig);

                statusEl.className = 'status success';
                statusEl.textContent = 'ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!';

                setTimeout(() => {
                    window.close();
                }, 1000);
            } catch (err) {
                statusEl.className = 'status error';
                statusEl.textContent = 'ì €ì¥ ì‹¤íŒ¨: ' + err.message;
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        document.addEventListener('DOMContentLoaded', loadSettings);
    </script>
</body>
</html>
