<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>í•™ì› ì¶œì„</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
        }

        .container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 8px;
            padding-top: env(safe-area-inset-top, 8px);
            padding-bottom: env(safe-area-inset-bottom, 8px);
        }

        /* í—¤ë” */
        .header {
            text-align: center;
            padding: 4px 0;
            border-bottom: 1px solid #333;
            margin-bottom: 8px;
        }

        .header h1 {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }

        .header .date {
            font-size: 11px;
            color: #888;
            margin-top: 2px;
        }

        /* ë¡œë”© */
        .loading {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 12px;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #333;
            border-top-color: #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ì„¤ì • í™”ë©´ */
        .setup {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px;
            text-align: center;
        }

        .setup h2 {
            font-size: 14px;
            margin-bottom: 12px;
        }

        .setup input {
            width: 100%;
            padding: 8px;
            border: 1px solid #444;
            border-radius: 8px;
            background: #2a2a4a;
            color: #fff;
            font-size: 11px;
            margin-bottom: 8px;
        }

        .setup button {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: #4CAF50;
            color: #fff;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        /* í•™ìƒ ëª©ë¡ */
        .student-list {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .student-card {
            background: #2a2a4a;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 8px;
            position: relative;
        }

        .student-card.checked-in {
            background: #1e3a1e;
            border-left: 3px solid #4CAF50;
        }

        .student-card.completed {
            background: #2a2a3a;
            opacity: 0.7;
        }

        .student-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .student-name {
            font-size: 14px;
            font-weight: 600;
        }

        .student-grade {
            font-size: 11px;
            color: #888;
            background: #333;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .student-time {
            font-size: 11px;
            color: #aaa;
            margin-bottom: 8px;
        }

        .timer {
            font-size: 20px;
            font-weight: bold;
            color: #4CAF50;
            text-align: center;
            margin: 8px 0;
            font-variant-numeric: tabular-nums;
        }

        .btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-checkin {
            background: #4CAF50;
            color: #fff;
        }

        .btn-checkout {
            background: #f44336;
            color: #fff;
        }

        .btn-disabled {
            background: #555;
            color: #888;
        }

        .completed-badge {
            text-align: center;
            color: #888;
            font-size: 11px;
            padding: 8px;
        }

        /* í•˜ë‹¨ ìƒíƒœ */
        .footer {
            text-align: center;
            padding: 8px 0;
            border-top: 1px solid #333;
            margin-top: 8px;
        }

        .footer .status {
            font-size: 10px;
            color: #666;
        }

        .footer .active-count {
            font-size: 12px;
            color: #4CAF50;
            font-weight: 600;
        }

        /* ì—ëŸ¬ ë©”ì‹œì§€ */
        .error {
            background: #4a1a1a;
            color: #ff6b6b;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 12px;
        }

        /* ë¹ˆ ìƒíƒœ */
        .empty {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #666;
            font-size: 12px;
        }

        .empty-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>í•™ì› ì¶œì„</h1>
            <div class="date" id="todayDate"></div>
        </div>

        <div id="content">
            <div class="loading">
                <div class="spinner"></div>
                <span style="font-size:11px;color:#888;">ë¡œë”©ì¤‘...</span>
            </div>
        </div>

        <div class="footer">
            <div class="active-count" id="activeCount">ìˆ˜ì—…ì¤‘: 0ëª…</div>
            <div class="status" id="syncStatus">ë™ê¸°í™” ëŒ€ê¸°</div>
        </div>
    </div>

    <script>
        // Notion ì„¤ì •
        const NOTION_API_KEY = localStorage.getItem('notionApiKey') || '';
        const STUDENTS_DB_ID = localStorage.getItem('studentsDbId') || '';
        const ATTENDANCE_DB_ID = localStorage.getItem('attendanceDbId') || '';

        // CORS í”„ë¡ì‹œ (Notion APIëŠ” ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ í˜¸ì¶œ ë¶ˆê°€)
        const CORS_PROXY = 'https://corsproxy.io/?';

        // ìƒíƒœ
        let students = [];
        let todayAttendance = {};
        let timers = {};

        // ì˜¤ëŠ˜ ìš”ì¼ (í™”/ëª©/í† )
        const dayMap = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const today = new Date();
        const todayDay = dayMap[today.getDay()];
        const todayStr = today.toISOString().split('T')[0];

        // ì´ˆê¸°í™”
        document.getElementById('todayDate').textContent =
            `${today.getMonth()+1}/${today.getDate()} (${todayDay})`;

        // ì„¤ì • í™•ì¸
        if (!NOTION_API_KEY || !STUDENTS_DB_ID) {
            showSetup();
        } else {
            loadData();
        }

        // ì„¤ì • í™”ë©´
        function showSetup() {
            document.getElementById('content').innerHTML = `
                <div class="setup">
                    <h2>Notion ì„¤ì •</h2>
                    <input type="text" id="apiKeyInput" placeholder="Notion API í‚¤" value="${NOTION_API_KEY}">
                    <input type="text" id="studentsDbInput" placeholder="í•™ìƒ DB ID" value="${STUDENTS_DB_ID}">
                    <input type="text" id="attendanceDbInput" placeholder="ì¶œì„ DB ID" value="${ATTENDANCE_DB_ID}">
                    <button onclick="saveSettings()">ì €ì¥</button>
                </div>
            `;
        }

        function saveSettings() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            const studentsDb = document.getElementById('studentsDbInput').value.trim();
            const attendanceDb = document.getElementById('attendanceDbInput').value.trim();

            if (!apiKey || !studentsDb) {
                alert('API í‚¤ì™€ í•™ìƒ DB IDëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤');
                return;
            }

            localStorage.setItem('notionApiKey', apiKey);
            localStorage.setItem('studentsDbId', studentsDb);
            localStorage.setItem('attendanceDbId', attendanceDb);

            location.reload();
        }

        // ë°ì´í„° ë¡œë“œ
        async function loadData() {
            try {
                updateStatus('í•™ìƒ ë¡œë”©ì¤‘...');

                // Notionì—ì„œ í•™ìƒ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const response = await fetch(CORS_PROXY + 'https://api.notion.com/v1/databases/' + STUDENTS_DB_ID + '/query', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + NOTION_API_KEY,
                        'Notion-Version': '2022-06-28',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });

                if (!response.ok) {
                    throw new Error('Notion API ì˜¤ë¥˜: ' + response.status);
                }

                const data = await response.json();
                students = data.results.map(parseStudent).filter(s => s.day.includes(todayDay));

                // ì‹œì‘ì‹œê°„ ê¸°ì¤€ ì •ë ¬
                students.sort((a, b) => a.startNum - b.startNum);

                renderStudents();
                updateStatus('ë™ê¸°í™” ì™„ë£Œ');
            } catch (error) {
                console.error('ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('content').innerHTML = `
                    <div class="error">
                        ì—°ê²° ì˜¤ë¥˜<br>
                        <small>${error.message}</small><br>
                        <button onclick="showSetup()" style="margin-top:8px;padding:6px 12px;border:none;border-radius:4px;background:#444;color:#fff;">ì„¤ì •</button>
                    </div>
                `;
            }
        }

        // í•™ìƒ ë°ì´í„° íŒŒì‹±
        function parseStudent(page) {
            const props = page.properties;
            const startNum = getProperty(props['ì‹œì‘ì‹œê°„']) || 0;
            const startTime = numberToTime(startNum);
            const endTime = getProperty(props['ì¢…ë£Œì‹œê°„']) || '';

            return {
                id: page.id,
                name: getProperty(props['ì´ë¦„']) || '',
                grade: getProperty(props['í•™ë…„']) || '',
                day: getProperty(props['ìš”ì¼']) || '',
                start: startTime,
                end: endTime,
                startNum: startNum,
                note: getProperty(props['ë¹„ê³ ']) || '',
                checkedIn: false,
                checkInTime: null,
                checkedOut: false,
                checkOutTime: null
            };
        }

        function getProperty(prop) {
            if (!prop) return '';
            switch (prop.type) {
                case 'title':
                    return prop.title[0]?.plain_text || '';
                case 'rich_text':
                    return prop.rich_text[0]?.plain_text || '';
                case 'select':
                    return prop.select?.name || '';
                case 'number':
                    return prop.number || 0;
                default:
                    return '';
            }
        }

        function numberToTime(num) {
            if (!num) return '';
            const hours = Math.floor(num / 100);
            const mins = num % 100;
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }

        // í•™ìƒ ëª©ë¡ ë Œë”ë§
        function renderStudents() {
            if (students.length === 0) {
                document.getElementById('content').innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">ğŸ“š</div>
                        <div>ì˜¤ëŠ˜(${todayDay}) ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤</div>
                    </div>
                `;
                return;
            }

            let html = '<div class="student-list">';

            students.forEach(student => {
                let cardClass = 'student-card';
                let buttonHtml = '';
                let timerHtml = '';

                if (student.checkedOut) {
                    cardClass += ' completed';
                    const duration = Math.floor((student.checkOutTime - student.checkInTime) / 60000);
                    buttonHtml = `<div class="completed-badge">âœ“ ${duration}ë¶„ ìˆ˜ì—…ì™„ë£Œ</div>`;
                } else if (student.checkedIn) {
                    cardClass += ' checked-in';
                    timerHtml = `<div class="timer" id="timer-${student.id}">00:00:00</div>`;
                    buttonHtml = `<button class="btn btn-checkout" onclick="checkout('${student.id}')">ì²´í¬ì•„ì›ƒ</button>`;
                    startTimer(student);
                } else {
                    buttonHtml = `<button class="btn btn-checkin" onclick="checkin('${student.id}')">ì²´í¬ì¸</button>`;
                }

                html += `
                    <div class="${cardClass}" id="card-${student.id}">
                        <div class="student-info">
                            <span class="student-name">${student.name}</span>
                            <span class="student-grade">${student.grade}</span>
                        </div>
                        <div class="student-time">${student.start} - ${student.end}</div>
                        ${timerHtml}
                        ${buttonHtml}
                    </div>
                `;
            });

            html += '</div>';
            document.getElementById('content').innerHTML = html;

            updateActiveCount();
        }

        // ì²´í¬ì¸
        function checkin(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            student.checkedIn = true;
            student.checkInTime = Date.now();

            renderStudents();
            saveAttendance(student, 'checkin');
        }

        // ì²´í¬ì•„ì›ƒ
        function checkout(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            student.checkedOut = true;
            student.checkOutTime = Date.now();

            if (timers[studentId]) {
                clearInterval(timers[studentId]);
                delete timers[studentId];
            }

            renderStudents();
            saveAttendance(student, 'checkout');
        }

        // íƒ€ì´ë¨¸ ì‹œì‘
        function startTimer(student) {
            if (timers[student.id]) return;

            timers[student.id] = setInterval(() => {
                const elapsed = Date.now() - student.checkInTime;
                const hours = Math.floor(elapsed / 3600000);
                const mins = Math.floor((elapsed % 3600000) / 60000);
                const secs = Math.floor((elapsed % 60000) / 1000);

                const timerEl = document.getElementById(`timer-${student.id}`);
                if (timerEl) {
                    timerEl.textContent =
                        `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

        // ì¶œì„ ì €ì¥ (Notion)
        async function saveAttendance(student, action) {
            if (!ATTENDANCE_DB_ID) {
                console.log('ì¶œì„ DB ID ì—†ìŒ, ë¡œì»¬ë§Œ ì €ì¥');
                return;
            }

            try {
                const now = new Date();
                const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

                if (action === 'checkout') {
                    const duration = Math.floor((student.checkOutTime - student.checkInTime) / 60000);
                    const checkInTime = new Date(student.checkInTime);
                    const checkInStr = `${checkInTime.getHours().toString().padStart(2, '0')}:${checkInTime.getMinutes().toString().padStart(2, '0')}`;

                    await fetch(CORS_PROXY + 'https://api.notion.com/v1/pages', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + NOTION_API_KEY,
                            'Notion-Version': '2022-06-28',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            parent: { database_id: ATTENDANCE_DB_ID },
                            properties: {
                                'ì´ë¦„': { title: [{ text: { content: student.name } }] },
                                'í•™ë…„': { select: { name: student.grade } },
                                'ë‚ ì§œ': { date: { start: todayStr } },
                                'ì²´í¬ì¸': { rich_text: [{ text: { content: checkInStr } }] },
                                'ì²´í¬ì•„ì›ƒ': { rich_text: [{ text: { content: timeStr } }] },
                                'ìˆ˜ì—…ì‹œê°„': { number: duration },
                                'ì˜ˆì •ì‹œê°„': { rich_text: [{ text: { content: `${student.start}-${student.end}` } }] }
                            }
                        })
                    });

                    updateStatus('ì¶œì„ ì €ì¥ë¨');
                }
            } catch (error) {
                console.error('ì¶œì„ ì €ì¥ ì˜¤ë¥˜:', error);
                updateStatus('ì €ì¥ ì˜¤ë¥˜');
            }
        }

        // í™œì„± í•™ìƒ ìˆ˜ ì—…ë°ì´íŠ¸
        function updateActiveCount() {
            const active = students.filter(s => s.checkedIn && !s.checkedOut).length;
            document.getElementById('activeCount').textContent = `ìˆ˜ì—…ì¤‘: ${active}ëª…`;
        }

        // ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateStatus(text) {
            document.getElementById('syncStatus').textContent = text;
        }

        // Service Worker ë“±ë¡
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(console.error);
        }
    </script>
</body>
</html>
